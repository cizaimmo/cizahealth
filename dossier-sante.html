<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Dossier médical</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<style>
:root{
  --blue:#123c8a;
  --blue-dark:#0b2c66;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:22px;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:linear-gradient(180deg,#f4f7fb,#eef3fa);
  color:var(--text);
}

.app{
  max-width:1000px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  padding:18px 22px;
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header strong{font-size:16px}
header a{
  color:#fff;
  text-decoration:none;
  font-size:13px;
}

/* SEGMENT CONTROL */
.segment{
  margin:20px auto;
  background:#eaf0fb;
  border-radius:999px;
  padding:4px;
  display:flex;
  width:95%;
  max-width:700px;
}
.segment button{
  flex:1;
  border:none;
  padding:12px;
  border-radius:999px;
  background:transparent;
  font-weight:600;
  cursor:pointer;
  font-size:13px;
  color:var(--blue);
  transition:.25s;
}
.segment button.active{
  background:linear-gradient(135deg,var(--blue),#1b4fa3);
  color:#fff;
  box-shadow:0 4px 14px rgba(18,60,138,.25);
}

/* CONTENT */
.content{
  padding:20px;
  flex:1;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(10,42,94,.08);
  margin-bottom:14px;
}

.card h3{
  margin:0 0 10px;
  font-size:15px;
}

.kv{
  font-size:14px;
  line-height:1.6;
}

.muted{color:var(--muted);font-size:13px}

.btn{
  margin-top:12px;
  padding:10px 14px;
  border:none;
  border-radius:14px;
  background:#eef3fb;
  color:var(--blue);
  font-weight:700;
  cursor:pointer;
}

.hidden{display:none}

.footer{
  text-align:center;
  font-size:12px;
  color:#8a95a8;
  padding:22px;
}
</style>
</head>

<body>
<div class="app">

<header>
  <strong>Dossier médical</strong>
  <a href="dashboard-client.html">← Retour</a>
</header>

<div class="segment">
  <button class="active" data-tab="identity">Identité</button>
  <button data-tab="reports">Rapports</button>
  <button data-tab="rx">Ordonnances</button>
  <button data-tab="card">Carte</button>
</div>

<div class="content">

  <!-- IDENTITÉ -->
  <div id="identity" class="tab">
    <div class="card">
      <h3>Informations patient</h3>
      <div class="kv" id="identityData">Chargement...</div>
    </div>
  </div>

  <!-- RAPPORTS -->
  <div id="reports" class="tab hidden">
    <div id="reportsList"></div>
  </div>

  <!-- ORDONNANCES -->
  <div id="rx" class="tab hidden">
    <div id="rxList"></div>
  </div>

  <!-- CARTE -->
  <div id="card" class="tab hidden">
    <div class="card" style="text-align:center">
      <h3>Carte médicale CizaHealth+</h3>
      <img id="qrImg" style="width:200px;margin-top:12px;border-radius:18px">
      <div class="muted" style="margin-top:10px">
        QR sécurisé signé
      </div>
    </div>
  </div>

</div>

<div class="footer">
© 2026 CizaHealth+ — CIZA GROUP
</div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc,
  collection, query, where, orderBy, onSnapshot
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* SEGMENT CONTROL */
document.querySelectorAll(".segment button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".segment button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab").forEach(t=>t.classList.add("hidden"));
    document.getElementById(btn.dataset.tab).classList.remove("hidden");
  };
});

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="login.html";
    return;
  }

  /* IDENTITÉ */
  const pSnap = await getDoc(doc(db,"patients",user.uid));
  if(pSnap.exists()){
    const p = pSnap.data();
    document.getElementById("identityData").innerHTML=`
      <b>Nom :</b> ${p.fullName || "—"}<br>
      <b>ID :</b> ${p.patientId || "—"}<br>
      <b>Genre :</b> ${p.gender || "—"}<br>
      <b>Âge :</b> ${p.age || "—"}<br>
      <b>Province :</b> ${p.province || "—"}
    `;
  }

  /* RAPPORTS */
  const qReports = query(
    collection(db,"reports"),
    where("patientUid","==",user.uid),
    orderBy("submittedAt","desc")
  );

  onSnapshot(qReports,(snap)=>{
    const container = document.getElementById("reportsList");
    container.innerHTML="";
    if(snap.empty){
      container.innerHTML="<div class='muted'>Aucun rapport disponible</div>";
      return;
    }
    snap.forEach(docu=>{
      const r = docu.data();
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <h3>Consultation</h3>
        <div class="kv">
          <b>Diagnostic :</b><br>${r.diagnostic || "—"}
        </div>
      `;
      container.appendChild(div);
    });
  });

  /* ORDONNANCES */
  const qRx = query(
    collection(db,"prescriptions"),
    where("patientUid","==",user.uid),
    orderBy("createdAt","desc")
  );

  onSnapshot(qRx,(snap)=>{
    const container = document.getElementById("rxList");
    container.innerHTML="";
    if(snap.empty){
      container.innerHTML="<div class='muted'>Aucune ordonnance</div>";
      return;
    }
    snap.forEach(docu=>{
      const p = docu.data();
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <h3>Ordonnance</h3>
        <div class="kv">
          <b>Code :</b> ${p.code}<br>
          <b>Statut :</b> ${p.used ? "Utilisée" : "Active"}
        </div>
        <button class="btn"
        onclick="location.href='ordonnance.html?requestId=${p.requestId}'">
        Voir ordonnance
        </button>
      `;
      container.appendChild(div);
    });
  });

});
</script>

</body>
</html>
