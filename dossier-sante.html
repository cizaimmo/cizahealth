<!-- DOSSIER SANTÉ PREMIUM VERSION A SECURISÉ -->
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Dossier médical</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="theme-color" content="#0b2c66">

<style>
:root{
  --blue:#123c8a;
  --blue-dark:#0b2c66;
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#6b7a90;
  --radius:22px;
  --line:#e7edf7;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:linear-gradient(180deg,#f4f7fb,#eef3fa);
}
.app{
  max-width:1100px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  padding:18px 22px;
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.segment{
  margin:20px auto;
  background:#eaf0fb;
  border-radius:999px;
  padding:4px;
  display:flex;
  width:95%;
  max-width:950px;
  flex-wrap:wrap;
}
.segment button{
  flex:1;
  border:none;
  padding:12px;
  border-radius:999px;
  background:transparent;
  font-weight:600;
  cursor:pointer;
  font-size:13px;
  color:var(--blue);
}
.segment button.active{
  background:linear-gradient(135deg,var(--blue),#1b4fa3);
  color:#fff;
}
.content{padding:20px;flex:1}
.card{
  background:white;
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 15px 40px rgba(0,0,0,.06);
  margin-bottom:14px;
  border:1px solid var(--line);
}
.kv{font-size:14px;line-height:1.6}
.muted{color:var(--muted);font-size:13px}
.hidden{display:none}
.profile{
  width:120px;
  height:120px;
  border-radius:50%;
  object-fit:cover;
  border:4px solid #eef3fb;
  cursor:pointer;
}
.footer{
  text-align:center;
  font-size:12px;
  color:#8a95a8;
  padding:22px;
}
.btn{
  padding:10px 16px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,var(--blue),#1b4fa3);
  color:white;
  cursor:pointer;
  font-weight:600;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="app">

<header>
<strong>Dossier médical</strong>
<a href="dashboard-client.html" style="color:white;text-decoration:none;">← Retour</a>
</header>

<div class="segment">
<button class="active" data-tab="identity">Identité</button>
<button data-tab="reports">Rapports</button>
<button data-tab="rx">Ordonnances</button>
<button data-tab="appointments">Rendez-vous</button>
<button data-tab="card">Carte</button>
</div>

<div class="content">

<div id="identity" class="tab">
<div class="card" style="text-align:center">
<input type="file" id="photoInput" hidden accept="image/*">
<img id="profilePhoto"
src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
class="profile">
<div class="muted">Touchez la photo pour modifier</div>
</div>
<div class="card">
<h3>Informations patient</h3>
<div id="identityData" class="kv">Chargement…</div>
</div>
</div>

<div id="reports" class="tab hidden">
<div id="reportsList"></div>
</div>

<div id="rx" class="tab hidden">
<div id="rxList"></div>
</div>

<div id="appointments" class="tab hidden">
<div id="appointmentsList"></div>
</div>

<div id="card" class="tab hidden">
<div class="card">
<h3>Carte médicale CizaHealth</h3>
<div id="cardNumber"></div>
<img id="qrImg" width="200">
</div>
</div>

</div>

<div class="footer">
Document médical strictement confidentiel – CizaHealth+<br>
© 2026 CIZA GROUP
</div>

</div>

<script type="module">
import { auth, db, storage } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
doc, getDoc,
collection, query, where, orderBy, onSnapshot, updateDoc
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
ref, uploadBytes, getDownloadURL
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* SECRET INTERNE */
const SECRET="CIZA_HEALTH_SECURE_2026";

/* SHA256 */
async function sha256(message){
const msgBuffer=new TextEncoder().encode(message);
const hashBuffer=await crypto.subtle.digest('SHA-256',msgBuffer);
return Array.from(new Uint8Array(hashBuffer))
.map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* TAB */
document.querySelectorAll(".segment button").forEach(btn=>{
btn.onclick=()=>{
document.querySelectorAll(".segment button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
document.querySelectorAll(".tab").forEach(t=>t.classList.add("hidden"));
document.getElementById(btn.dataset.tab).classList.remove("hidden");
};
});

onAuthStateChanged(auth, async(user)=>{
if(!user){location.href="login.html";return;}

const pSnap=await getDoc(doc(db,"patients",user.uid));
if(!pSnap.exists()) return;
const p=pSnap.data();

/* IDENTITE */
document.getElementById("identityData").innerHTML=`
<b>Nom :</b> ${p.fullName || "—"}<br>
<b>ID :</b> ${p.patientId || "—"}<br>
<b>Genre :</b> ${p.gender || "—"}<br>
<b>Âge :</b> ${p.age || "—"}<br>
<b>Province :</b> ${p.province || "—"}
`;

if(p.photoURL){
document.getElementById("profilePhoto").src=p.photoURL;
}

/* PHOTO */
document.getElementById("profilePhoto").onclick=()=>{
document.getElementById("photoInput").click();
};
document.getElementById("photoInput").onchange=async(e)=>{
const file=e.target.files[0];
if(!file) return;
const storageRef=ref(storage,`patients/${user.uid}/profile.jpg`);
await uploadBytes(storageRef,file);
const url=await getDownloadURL(storageRef);
await updateDoc(doc(db,"patients",user.uid),{photoURL:url});
document.getElementById("profilePhoto").src=url;
};

/* REPORTS */
const qReports=query(
collection(db,"reports"),
where("patientUid","==",user.uid),
orderBy("submittedAt","desc")
);
onSnapshot(qReports,async(snap)=>{
const container=document.getElementById("reportsList");
container.innerHTML="";
if(snap.empty){
container.innerHTML="<div class='card'><div class='muted'>Aucun rapport</div></div>";
return;
}
snap.forEach(docu=>{
const r=docu.data();
const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<h3>Consultation</h3>
<div class="kv">
<b>Médecin :</b> Dr ${r.proName || "—"}<br>
<b>Diagnostic :</b><br>${r.diagnostic || "—"}<br>
<b>Traitement :</b><br>${r.traitement || "—"}<br>
<div class="muted">Date : ${r.submittedAt?.toDate()?.toLocaleString() || "—"}</div>
<button class="btn" onclick="generatePDF('${r.proName}','${r.diagnostic}','${r.traitement}')">Télécharger PDF</button>
</div>
`;
container.appendChild(div);
});
});

/* RX SECURISÉ */
const qRx=query(
collection(db,"prescriptions"),
where("patientUid","==",user.uid),
orderBy("createdAt","desc")
);
onSnapshot(qRx,async(snap)=>{
const container=document.getElementById("rxList");
container.innerHTML="";
if(snap.empty){
container.innerHTML="<div class='card'><div class='muted'>Aucune ordonnance</div></div>";
return;
}
for(const docu of snap.docs){
const r=docu.data();
const ts=Date.now();
const signature=await sha256(r.code+user.uid+ts+SECRET);
const payload=encodeURIComponent(JSON.stringify({
code:r.code,
uid:user.uid,
ts,
sig:signature
}));
const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<h3>Ordonnance</h3>
<b>Code :</b> ${r.code}<br>
<b>Date :</b> ${r.createdAt?.toDate()?.toLocaleString() || "—"}<br>
<b>Statut :</b> ${r.used ? "Utilisée" : "Active"}<br>
<img width="160" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${payload}">
`;
container.appendChild(div);
}
});

/* APPOINTMENTS (intact) */
const qApp=query(
collection(db,"appointments"),
where("patientUid","==",user.uid),
orderBy("date","desc")
);
onSnapshot(qApp,(snap)=>{
const container=document.getElementById("appointmentsList");
container.innerHTML="";
if(snap.empty){
container.innerHTML="<div class='card'><div class='muted'>Aucun rendez-vous</div></div>";
return;
}
snap.forEach(docu=>{
const a=docu.data();
const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<b>Date :</b> ${new Date(a.date).toLocaleString()}<br>
<b>Médecin :</b> ${a.proName || "—"}<br>
<b>Statut :</b> ${a.status || "Planifié"}
`;
container.appendChild(div);
});
});

/* CARTE SECURISÉE */
const cardNumber="CZ-H-"+user.uid.slice(0,4).toUpperCase();
document.getElementById("cardNumber").innerText=cardNumber;
const ts=Date.now();
const sig=await sha256(user.uid+cardNumber+ts+SECRET);
const cardPayload=encodeURIComponent(JSON.stringify({
uid:user.uid,
card:cardNumber,
ts,
sig
}));
document.getElementById("qrImg").src=
`https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=${cardPayload}`;

});

/* PDF PREMIUM */
window.generatePDF=function(pro,diag,trait){
const w=window.open();
w.document.write(`
<html>
<head>
<title>Rapport médical</title>
<style>
body{font-family:Arial;padding:40px;}
h1{color:#123c8a}
.footer{margin-top:40px;font-size:12px;color:#777;}
</style>
</head>
<body>
<h1>CizaHealth+ Rapport médical</h1>
<p><b>Médecin :</b> Dr ${pro}</p>
<p><b>Diagnostic :</b><br>${diag}</p>
<p><b>Traitement :</b><br>${trait}</p>
<hr>
<p>Signature électronique : CIZAHEALTH VERIFIED</p>
<div class="footer">
Document confidentiel – Toute reproduction interdite.<br>
© 2026 CIZA GROUP
</div>
</body>
</html>
`);
w.document.close();
w.print();
}
</script>

</body>
</html>
