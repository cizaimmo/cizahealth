<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Dossier m√©dical</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<!-- PWA / WebView -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<style>
:root{
  --blue:#123c8a;
  --blue-dark:#0b2c66;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:22px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:linear-gradient(180deg,#f4f7fb,#eef3fa);
  color:var(--text);
}
.app{
  max-width:1000px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  padding:18px 22px;
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:#fff;
}
header strong{font-size:16px;display:block}
header span{font-size:12px;opacity:.9}

/* CONTENT */
.content{padding:22px}
.section{margin-bottom:26px}
.section h2{
  font-size:18px;
  margin:0 0 14px;
}

/* CARD */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(10,42,94,.08);
  margin-bottom:14px;
}
.card small{color:var(--muted);font-size:12px}
.card h3{
  margin:6px 0 10px;
  font-size:15px;
}
.kv{
  font-size:13.5px;
  line-height:1.6;
  color:var(--text);
}
.kv span{color:var(--muted)}

/* BUTTON */
.btn{
  margin-top:12px;
  padding:12px 16px;
  border:none;
  border-radius:16px;
  background:#eef3fb;
  color:var(--blue);
  font-weight:700;
  cursor:pointer;
}

/* EMPTY */
.empty{
  padding:22px;
  text-align:center;
  color:var(--muted);
  font-size:14px;
}

/* FOOTER */
.footer{
  margin-top:auto;
  padding:22px;
  text-align:center;
  font-size:12px;
  color:#8a95a8;
}
</style>
</head>

<body>
<div class="app">

<header>
  <strong>Dossier m√©dical</strong>
  <span>Historique de vos consultations et documents</span>
</header>

<div class="content">

  <!-- RAPPORTS -->
  <div class="section">
    <h2>Rapports m√©dicaux</h2>
    <div id="reportsList"></div>
  </div>

  <!-- ORDONNANCES -->
  <div class="section">
    <h2>Ordonnances</h2>
    <div id="rxList"></div>
  </div>

</div>

<div class="footer">
  ¬© 2026 CizaHealth+ ‚Äî CIZA GROUP<br>
  Dossier patient s√©curis√© ‚Ä¢ Acc√®s personnel
</div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, query, where, orderBy, onSnapshot
}
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const reportsList = document.getElementById("reportsList");
const rxList = document.getElementById("rxList");

function fmtDate(ts){
  try{
    const d = ts?.toDate ? ts.toDate() : null;
    if(!d) return "‚Äî";
    return d.toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"numeric"});
  }catch(e){ return "‚Äî"; }
}

onAuthStateChanged(auth,(user)=>{
  if(!user){
    location.href="login.html";
    return;
  }

  /* üìÑ RAPPORTS */
  const qReports = query(
    collection(db,"reports"),
    where("patientUid","==",user.uid),
    orderBy("submittedAt","desc")
  );

  onSnapshot(qReports,(snap)=>{
    reportsList.innerHTML="";
    if(snap.empty){
      reportsList.innerHTML=`<div class="empty">Aucun rapport m√©dical disponible.</div>`;
      return;
    }
    snap.forEach(docu=>{
      const r = docu.data();
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <small>${fmtDate(r.submittedAt)}</small>
        <h3>Consultation m√©dicale</h3>
        <div class="kv">
          <span>Diagnostic :</span><br>
          ${r.diagnostic || "‚Äî"}
        </div>
        <button class="btn" onclick="location.href='rapport-view.html?requestId=${r.requestId || docu.id}'">
          Voir le rapport
        </button>
      `;
      reportsList.appendChild(div);
    });
  });

  /* üíä ORDONNANCES */
  const qRx = query(
    collection(db,"prescriptions"),
    where("patientUid","==",user.uid),
    orderBy("createdAt","desc")
  );

  onSnapshot(qRx,(snap)=>{
    rxList.innerHTML="";
    if(snap.empty){
      rxList.innerHTML=`<div class="empty">Aucune ordonnance disponible.</div>`;
      return;
    }
    snap.forEach(docu=>{
      const p = docu.data();
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <small>${fmtDate(p.createdAt)}</small>
        <h3>Ordonnance</h3>
        <div class="kv">
          <span>Code :</span> <b>${p.code || "‚Äî"}</b><br>
          <span>Statut :</span> ${p.used ? "Utilis√©e" : "Active"}
        </div>
        <button class="btn" onclick="location.href='ordonnance.html?requestId=${p.requestId || docu.id}'">
          Voir l‚Äôordonnance
        </button>
      `;
      rxList.appendChild(div);
    });
  });

});
</script>

</body>
</html>
