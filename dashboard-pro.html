<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Dashboard Professionnel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#123c8a;
  --green:#1b6b3a;
  --red:#c0392b;
  --orange:#e67e22;
  --bg:#f4f7fb;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:20px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;background:var(--bg);color:var(--text)}
.app{max-width:1300px;margin:auto;min-height:100vh;background:#fff;display:flex;flex-direction:column}
header{background:linear-gradient(90deg,#123c8a,#0b2c66);color:#fff;padding:18px 22px;display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;align-items:center;gap:14px}
.brand img.photo{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #fff}
.content{padding:24px;display:grid;gap:24px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:0 10px 28px rgba(10,42,94,.08)}
.request{border:1px solid #eef1f6;border-radius:16px;padding:16px;margin-bottom:14px}
.request.pending{border-left:6px solid var(--orange)}
.request.assigned{border-left:6px solid var(--green)}
.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
.actions button{padding:12px;border:none;border-radius:14px;font-weight:800;color:#fff;cursor:pointer}
.accept{background:var(--green)}
.refuse{background:var(--red)}
.chat{background:#123c8a}
.call{background:#6c5ce7}
.report{background:#0b2c66}
.empty{color:var(--muted);font-size:14px}
.big{font-size:26px;font-weight:800}
footer{margin-top:auto;padding:18px;border-top:1px solid #eef1f6;text-align:center;font-size:12px;color:#6b7a90}
.badge{background:#e74c3c;color:#fff;border-radius:999px;padding:3px 9px;font-size:12px}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <img id="proPhoto" class="photo"
      src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <div>
      <strong id="proName">â€”</strong><br>
      <span id="proMeta">â€”</span>
    </div>
  </div>
  <div>
    <span>ğŸ”” <span id="notifCount" class="badge">0</span></span>
    <button id="logoutBtn">DÃ©connexion</button>
  </div>
</header>

<div class="content">

<!-- STATS -->
<div class="grid4">
  <div class="card"><h3>AcceptÃ©es</h3><div id="statAccepted" class="big">0</div></div>
  <div class="card"><h3>RefusÃ©es</h3><div id="statRefused" class="big">0</div></div>
  <div class="card"><h3>Actives</h3><div id="statActive" class="big">0</div></div>
  <div class="card"><h3>Rapports</h3><div id="statReports" class="big">0</div></div>
</div>

<!-- PENDING -->
<div class="card">
  <h3>ğŸŸ¡ RequÃªtes en attente</h3>
  <div id="pendingList" class="empty">Chargementâ€¦</div>
</div>

<!-- ASSIGNED -->
<div class="card">
  <h3>ğŸŸ¢ RequÃªtes acceptÃ©es</h3>
  <div id="assignedList" class="empty">Aucune demande</div>
</div>

</div>

<footer>Â© 2026 CizaHealth+</footer>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, query, where, onSnapshot,
  doc, updateDoc, serverTimestamp,
  getDoc
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const logoutBtn=document.getElementById("logoutBtn");
logoutBtn.onclick=async()=>{
  await signOut(auth);
  location.href="/cizahealth/index.html";
};

onAuthStateChanged(auth, async(user)=>{
  if(!user) return location.href="/cizahealth/index.html";

  const proSnap=await getDoc(doc(db,"users",user.uid));
  if(!proSnap.exists()) return;
  const p=proSnap.data();

  const fullName=p.fullName||"MÃ©decin";
  const speciality=p.speciality||"MÃ©decin";
  const province=p.province||"";
  const photo=p.photoURL||"";

  document.getElementById("proName").textContent=fullName;
  document.getElementById("proMeta").textContent=`${speciality} â€¢ ${province}`;
  if(photo) document.getElementById("proPhoto").src=photo;

  /* ğŸ”” NOTIFICATIONS */
  onSnapshot(query(collection(db,"notifications"),where("receiverId","==",user.uid)),snap=>{
    document.getElementById("notifCount").textContent=snap.size;
  });

  /* ğŸŸ¡ PENDING MATCHING PAR PROVINCE */
  onSnapshot(
    query(collection(db,"requests"),
      where("status","==","pending"),
      where("province","==",province)
    ),
    snap=>{
      const container=document.getElementById("pendingList");
      container.innerHTML="";
      if(snap.empty){container.innerHTML='<div class="empty">Aucune requÃªte</div>';return;}

      snap.forEach(d=>{
        const r=d.data();
        const div=document.createElement("div");
        div.className="request pending";
        div.innerHTML=`
<strong>${r.fullName||"Patient"}</strong>
<div class="empty">${r.province||""}</div>
<div class="actions">
<button class="accept">Accepter</button>
<button class="refuse">Refuser</button>
<button class="chat" disabled>Chat</button>
</div>`;

        div.querySelector(".accept").onclick=async()=>{
          await updateDoc(doc(db,"requests",d.id),{
            status:"assigned",
            assignedProUid:user.uid,
            assignedProName:fullName,
            assignedProSpeciality:speciality,
            assignedProProvince:province,
            assignedProPhoto:photo,
            assignedAt:serverTimestamp()
          });
        };

        div.querySelector(".refuse").onclick=async()=>{
          await updateDoc(doc(db,"requests",d.id),{
            status:"refused",
            refusedBy:user.uid,
            refusedAt:serverTimestamp()
          });
        };

        container.appendChild(div);
      });
    }
  );

  /* ğŸŸ¢ ASSIGNED */
  onSnapshot(
    query(collection(db,"requests"),
      where("assignedProUid","==",user.uid)
    ),
    snap=>{
      const container=document.getElementById("assignedList");
      container.innerHTML="";
      let active=0;

      snap.forEach(d=>{
        const r=d.data();
        if(r.status==="assigned"||r.status==="in_call"){
          active++;
          const div=document.createElement("div");
          div.className="request assigned";
          div.innerHTML=`
<strong>Consultation</strong>
<div class="actions">
<button class="call">ğŸ“ Appeler</button>
<button class="chat">ğŸ’¬ Chat</button>
<button class="report">ğŸ“ Rapport</button>
</div>`;
          div.querySelector(".call").onclick=()=>location.href=`/cizahealth/call.html?requestId=${d.id}&role=pro`;
          div.querySelector(".chat").onclick=()=>location.href=`/cizahealth/chat.html?requestId=${d.id}&role=pro`;
          div.querySelector(".report").onclick=()=>location.href=`/cizahealth/report.html?requestId=${d.id}&role=pro`;
          container.appendChild(div);
        }
      });

      document.getElementById("statActive").textContent=active;
      document.getElementById("statAccepted").textContent=active;
    }
  );

});
</script>

</body>
</html>
