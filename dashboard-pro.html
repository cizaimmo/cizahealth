<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Dashboard Professionnel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#123c8a;
  --green:#1b6b3a;
  --orange:#e67e22;
  --red:#c0392b;
  --bg:#f4f7fb;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:22px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:1200px;
  margin:auto;
  min-height:100vh;
  background:#fff;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
.header{
  padding:20px 24px;
  border-bottom:1px solid #eef1f6;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
}
.brand{
  display:flex;
  align-items:center;
  gap:14px;
}
.brand img{height:42px}
.brand strong{font-size:16px}
.brand span{font-size:12px;color:var(--muted)}

.status{
  padding:6px 14px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.available{background:#eaf6f0;color:var(--green)}
.suspended{background:#fdecea;color:var(--red)}

.topRight{
  display:flex;
  align-items:center;
  gap:10px;
}
.logout{
  border:none;
  background:none;
  color:var(--red);
  font-weight:600;
  cursor:pointer;
}

/* ===== CONTENT ===== */
.content{padding:26px;display:grid;gap:26px}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px}
.kpi{
  background:#fff;
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(10,42,94,.08)
}
.kpi strong{font-size:22px}

.card{
  background:#fff;
  border-radius:var(--radius);
  padding:22px;
  box-shadow:0 10px 28px rgba(10,42,94,.08)
}

.request{border:1px solid #eef1f6;border-radius:16px;padding:16px;margin-bottom:14px}
.actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.actions button{
  flex:1;min-width:140px;padding:12px;border:none;
  border-radius:14px;font-weight:600;color:#fff;cursor:pointer
}
.audio{background:#1b4fa3}
.chat{background:#27ae60}
.close{background:#c0392b}

.notif{font-size:13px;padding:10px;border-bottom:1px dashed #eee;cursor:pointer}
.notif.unread{background:#eef4ff;font-weight:600}
.empty{font-size:14px;color:var(--muted)}

.badgeDot{
  min-width:22px;height:22px;padding:0 8px;
  border-radius:999px;background:#eef4ff;
  color:#123c8a;font-size:12px;font-weight:700;
  border:1px solid #d9e6ff
}
.iconBtn{
  border:1px solid #e6ebf5;background:#fff;
  border-radius:12px;padding:8px 10px;
  cursor:pointer;font-weight:600
}

/* ===== FOOTER ===== */
footer{
  margin-top:auto;
  padding:20px;
  border-top:1px solid #eef1f6;
  text-align:center;
  font-size:12px;
  color:#6b7a90;
}
</style>
</head>

<body>
<div class="app">

<!-- ===== HEADER INSTITUTIONNEL ===== -->
<header class="header">
  <div class="brand">
    <img src="https://raw.githubusercontent.com/cizaimmo/cizahealth/main/9008F813-82B0-4A0C-8B18-00CA519A77CF.png" alt="CizaHealth+">
    <div>
      <strong>CizaHealth+</strong><br>
      <span>Tableau de bord professionnel</span>
    </div>
  </div>

  <div class="topRight">
    <button class="iconBtn" id="markAllReadBtn">üîî <span id="unreadCount" class="badgeDot">0</span></button>
    <span class="status available" id="proStatus">Actif</span>
    <button class="logout" id="logoutBtn">D√©connexion</button>
  </div>
</header>

<!-- ===== CONTENU ===== -->
<div class="content">

  <div>
    <strong id="proName">‚Äî</strong><br>
    <span id="proMeta">‚Äî</span><br>
    <span id="proProvince">‚Äî</span>
  </div>

  <div class="kpis">
    <div class="kpi">Consultations aujourd‚Äôhui<br><strong id="kpiToday">0</strong></div>
    <div class="kpi">Demandes actives<br><strong id="kpiWaiting">0</strong></div>
    <div class="kpi">Revenus estim√©s<br><strong id="kpiRevenue">0 BIF</strong></div>
  </div>

  <div class="card">
    <h3>Demandes assign√©es</h3>
    <div id="requestsList" class="empty">Chargement‚Ä¶</div>
  </div>

  <div class="card">
    <h3>Notifications</h3>
    <div id="notificationsList" class="empty">Aucune notification</div>
  </div>

</div>

<!-- ===== FOOTER ===== -->
<footer>
  <div>¬© 2026 <strong>CizaHealth+</strong> ‚Äî CIZA GROUP</div>
  <div>Plateforme professionnelle de sant√© ‚Ä¢ Acc√®s s√©curis√© ‚Ä¢ Donn√©es confidentielles</div>
  <div>Version MVP ‚Ä¢ Environnement production</div>
</footer>

</div>

<! ‚ö†Ô∏è TON SCRIPT JS ORIGINAL EST CONSERV√â √Ä L‚ÄôIDENTIQUE -->
<!-- (je ne le recolle pas ici pour √©viter toute duplication accidentelle) -->
<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, collection, query, where,
  onSnapshot, updateDoc, addDoc, serverTimestamp, orderBy,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

logoutBtn.onclick=async()=>{await signOut(auth);location.href="/cizahealth/index.html";};

const todayStart = new Date(); todayStart.setHours(0,0,0,0);

const patientCache = new Map();
async function getPatient(uid){
  if(!uid) return null;
  if(patientCache.has(uid)) return patientCache.get(uid);
  try{
    const s = await getDoc(doc(db,"users",uid));
    const val = s.exists() ? s.data() : null;
    patientCache.set(uid,val);
    return val;
  }catch(e){
    patientCache.set(uid,null);
    return null;
  }
}

async function audit(actor, action, target, extra={}){
  await addDoc(collection(db,"auditLogs"),{
    actor, action, target, extra,
    at: serverTimestamp()
  });
}
async function notify(fromUid, toUid, title, message){
  if(!toUid) return;
  await addDoc(collection(db,"notifications"),{
    toUid, title, message,
    read:false,
    createdAt:serverTimestamp(),
    createdBy:fromUid
  });
}

function fmtMoney(x){
  const n = Number(x||0);
  if(!Number.isFinite(n)) return "0";
  return String(Math.round(n));
}

let currentUser = null;
let currentPro = null;

let pendingClose = { requestId:null, requestData:null };

function openCloseModal(requestId, requestData){
  pendingClose = { requestId, requestData };
  closeNote.value = "";
  closeAmount.value = "";

  const r = requestData || {};
  const base = [
    `Demande : ${requestId}`,
    `Service : ${r.serviceType||"‚Äî"}`,
    `Statut : ${r.status||"‚Äî"}`,
    `Province : ${r.province||"‚Äî"}`
  ];
  if(r.patientUid) base.push(`Patient UID : ${r.patientUid}`);
  closeModalSummary.textContent = base.join(" ‚Ä¢ ");

  // propose montant : priorit√© aux champs existants si pr√©sents
  const suggested = (r.proAmount ?? r.pricePro ?? r.proFee ?? r.amount ?? r.price ?? 5000);
  closeAmount.value = Number(suggested||0);

  closeModalBack.style.display="flex";
}
function closeCloseModal(){
  closeModalBack.style.display="none";
  pendingClose = { requestId:null, requestData:null };
}

closeModalX.onclick = closeCloseModal;
closeModalCancel.onclick = closeCloseModal;
closeModalBack.addEventListener("click",(e)=>{ if(e.target === closeModalBack) closeCloseModal(); });

markAllReadBtn.onclick = async()=>{
  if(!currentUser) return;
  // Marquer toutes les notifs comme lues (c√¥t√© pro)
  // NB: sans batch pour rester simple; OK pour MVP
  const nq = query(collection(db,"notifications"),where("toUid","==",currentUser.uid),where("read","==",false));
  onSnapshot(nq, async (snap)=>{
    if(snap.empty) return;
    for(const d of snap.docs){
      await updateDoc(doc(db,"notifications",d.id),{read:true});
    }
  });
};

onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="/cizahealth/index.html";
  currentUser = user;

  const uSnap = await getDoc(doc(db,"users",user.uid));
  if(!uSnap.exists()) return document.body.innerHTML="Acc√®s refus√©";

  const pro = uSnap.data();
  currentPro = pro;

  // ‚úÖ S√©curit√© m√©tier (garde exactement la logique)
  if(!["doctor","nurse","aide"].includes(pro.role) || pro.status!=="validated" || !pro.documentsVerified || pro.accountStatus==="suspended"){
    document.body.innerHTML="<h2 style='padding:40px'>Compte non autoris√©</h2>";
    return;
  }

  proName.textContent = pro.fullName || "‚Äî";
  proMeta.textContent = `${pro.specialty||"‚Äî"} ‚Ä¢ ${pro.proId||"‚Äî"}`;
  proProvince.textContent = `Province : ${pro.province||"‚Äî"}`;

  /* ===== REQUESTS + KPI (corrig√© ‚Äúaujourd‚Äôhui‚Äù) + lien patient ===== */
  const rq = query(collection(db,"requests"), where("assignedProUid","==",user.uid));

  onSnapshot(rq, async (s)=>{
    requestsList.innerHTML="";
    let today=0, active=0;

    // On construit les cartes dans l‚Äôordre de lecture Firestore; si tu veux tri, il faudra orderBy + index
    for(const d of s.docs){
      const r = d.data();

      const isClosedToday =
        r.status==="closed" &&
        r.closedAt?.toDate &&
        r.closedAt.toDate() >= todayStart;

      if(isClosedToday) today++;

      const isActive = ["assigned","in_progress"].includes(r.status);
      if(isActive) active++;

      if(isActive){
        const patientUid = r.patientUid || r.patientId || r.clientUid || r.userUid || null;
        const patient = await getPatient(patientUid);

        const patientName = patient?.fullName || patient?.name || (patientUid ? ("UID: "+patientUid.slice(0,8)+"‚Ä¶") : "‚Äî");
        const patientPhone = patient?.phone || patient?.phoneNumber || "‚Äî";
        const patientEmail = patient?.email || "‚Äî";

        const div = document.createElement("div");
        div.className="request";

        const created = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "‚Äî";
        const statusLabel = r.status || "‚Äî";
        const priceHint = (r.proAmount ?? r.pricePro ?? r.proFee ?? r.amount ?? r.price ?? null);

        div.innerHTML = `
<strong>Patient</strong> ‚Äî ${patientName}<br>
<div class="metaRow">
  <span class="tag">üìû ${patientPhone}</span>
  <span class="tag">‚úâÔ∏è ${patientEmail}</span>
  <span class="tag">üóìÔ∏è ${created}</span>
  <span class="tag">üìå ${r.province||pro.province||"‚Äî"}</span>
  <span class="tag">üìÑ Statut : ${statusLabel}</span>
  ${priceHint!=null?`<span class="tag">üí∞ Suggestion : ${fmtMoney(priceHint)} BIF</span>`:""}
</div>
<div style="margin-top:10px;font-size:13px;color:var(--text)">
  <strong>Service</strong> ‚Äî ${r.serviceType||r.type||"‚Äî"}<br>
  <span style="color:var(--muted)">${r.details||r.description||""}</span>
</div>

<div class="actions">
  <button class="audio">${r.status==="in_progress"?"En cours":"D√©marrer"}</button>
  <button class="chat">Chat</button>
  <button class="close">Cl√¥turer</button>
</div>
`;

        // ‚úÖ D√©marrer : passe en in_progress (et garde startedAt)
        div.querySelector(".audio").onclick = async ()=>{
          await updateDoc(doc(db,"requests",d.id),{
            status:"in_progress",
            startedAt: serverTimestamp(),
            lastUpdatedAt: serverTimestamp()
          });
          await audit(user.uid,"start_request",d.id,{status:"in_progress"});
        };

        // ‚úÖ Chat : cr√©e/ouvre une conversation r√©utilisable (docId stable)
        div.querySelector(".chat").onclick = async ()=>{
          const chatId = `CHAT_${d.id}_${user.uid}`;
          await setDoc(doc(db,"chats",chatId),{
            chatId,
            requestId: d.id,
            proUid: user.uid,
            patientUid: patientUid || null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            status:"active"
          },{merge:true});

          await audit(user.uid,"open_chat",chatId,{requestId:d.id});

          // UX : ouvre une page chat si tu la cr√©es plus tard, sinon info
          // (tu peux cr√©er chat.html ensuite)
          alert("Chat pr√™t. ID: "+chatId+" (tu peux cr√©er chat.html plus tard).");
        };

        // ‚úÖ Cl√¥turer : confirmation + note obligatoire + transaction + audit + notification patient
        div.querySelector(".close").onclick = async ()=>{
          openCloseModal(d.id, r);
        };

        requestsList.appendChild(div);
      }
    }

    kpiToday.textContent = today;
    kpiWaiting.textContent = active;
    if(!requestsList.innerHTML) requestsList.innerHTML = '<div class="empty">Aucune demande</div>';
  });

  // Action bouton modal ‚Äúconfirmer cl√¥ture‚Äù
  closeModalConfirm.onclick = async ()=>{
    if(!pendingClose.requestId || !pendingClose.requestData) return closeCloseModal();

    const requestId = pendingClose.requestId;
    const r = pendingClose.requestData;

    const note = (closeNote.value || "").trim();
    if(!note) return alert("Note obligatoire avant cl√¥ture.");

    const amount = Number(closeAmount.value || 0);
    const safeAmount = Number.isFinite(amount) ? amount : 0;

    // Re-check anti double-close
    const confirmOk = confirm("Confirmer la cl√¥ture ? Cette action est enregistr√©e.");
    if(!confirmOk) return;

    // Statut request
    await updateDoc(doc(db,"requests",requestId),{
      status:"closed",
      closedAt: serverTimestamp(),
      closedBy: currentUser.uid,
      closeNote: note,
      lastUpdatedAt: serverTimestamp()
    });

    // Transaction (montant dynamique si champ existant, sinon saisie, sinon 5000)
    const suggested = (r.proAmount ?? r.pricePro ?? r.proFee ?? r.amount ?? r.price ?? 5000);
    const finalAmount = safeAmount > 0 ? safeAmount : Number(suggested||0) || 0;

    await addDoc(collection(db,"transactions"),{
      requestId,
      proUid: currentUser.uid,
      patientUid: r.patientUid || r.patientId || r.clientUid || r.userUid || null,
      amount: finalAmount,
      currency: "BIF",
      status: "success",
      method: r.paymentMethod || "wallet",
      createdAt: serverTimestamp(),
      meta: {
        specialty: currentPro?.specialty || null,
        province: currentPro?.province || null
      }
    });

    // Audit (tra√ßabilit√©)
    await addDoc(collection(db,"auditLogs"),{
      actor: currentUser.uid,
      action: "close_request",
      target: requestId,
      extra: {
        amount: finalAmount,
        notePreview: note.slice(0,140)
      },
      at: serverTimestamp()
    });

    // Notifier patient (si patientUid existe)
    const patientUid = r.patientUid || r.patientId || r.clientUid || r.userUid || null;
    if(patientUid){
      await notify(currentUser.uid, patientUid, "Consultation cl√¥tur√©e", "Votre consultation a √©t√© cl√¥tur√©e. Un r√©sum√© est disponible si n√©cessaire.");
    }

    closeCloseModal();
  };

  /* ===== REVENUS (d√©j√† ok, mais filtrage success si tu veux) ===== */
  onSnapshot(query(collection(db,"transactions"),where("proUid","==",user.uid)), s=>{
    let total=0;
    s.forEach(d=>{
      const t=d.data();
      if(t.status && t.status!=="success") return;
      total += Number(t.amount||0);
    });
    kpiRevenue.textContent = total+" BIF";
  });

  /* ===== NOTIFS : compteur + clic = read + ‚ÄúAucune notification‚Äù ===== */
  const notifsQuery = query(
    collection(db,"notifications"),
    where("toUid","==",user.uid),
    orderBy("createdAt","desc")
  );

  onSnapshot(notifsQuery, s=>{
    notificationsList.innerHTML="";
    let unread=0;

    if(s.empty){
      notificationsList.innerHTML='<div class="empty">Aucune notification</div>';
      unreadCount.textContent="0";
      return;
    }

    s.forEach(d=>{
      const n=d.data();
      if(!n.read) unread++;

      const div=document.createElement("div");
      div.className="notif"+(n.read?"":" unread");

      const when = n.createdAt?.toDate ? n.createdAt.toDate().toLocaleString() : "";
      div.innerHTML=`<strong>${n.title||"Info"}</strong><br>${n.message||""}${when?`<div class="smallMuted">${when}</div>`:""}`;

      div.onclick = async ()=>{
        await updateDoc(doc(db,"notifications",d.id),{read:true});
      };

      notificationsList.appendChild(div);
    });

    unreadCount.textContent = String(unread);
  });

});
</script>
  
</body>
</html>
</body>
</html>
