<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CizaHealth+ | Dashboard Professionnel</title>

<style>
:root{
  --primary:#0E3A8A;
  --primary-dark:#0A2F6A;
  --success:#1B6B3A;
  --warning:#F39C12;
  --danger:#C0392B;
  --bg:#F4F7FB;
  --card:#FFFFFF;
  --text:#0A1A2F;
  --muted:#6B7A90;
  --radius:20px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  background:linear-gradient(90deg,var(--primary),var(--primary-dark));
  color:#fff;
  padding:18px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand{
  display:flex;
  flex-direction:column;
}

.status{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:700;
}

.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:red;
}
.dot.online{background:#2ecc71}

.notif-btn{
  position:relative;
  background:#fff;
  border:none;
  padding:8px 14px;
  border-radius:12px;
  cursor:pointer;
  font-weight:700;
}
.badge{
  position:absolute;
  top:-6px;
  right:-6px;
  background:var(--danger);
  color:#fff;
  font-size:11px;
  padding:3px 6px;
  border-radius:999px;
}

/* MAIN */
main{
  max-width:1200px;
  margin:auto;
  padding:24px;
}

/* KPI */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:16px;
}

.kpi{
  background:#fff;
  padding:18px;
  border-radius:var(--radius);
  box-shadow:0 10px 26px rgba(10,42,94,.08);
}
.kpi h4{
  margin:0;
  font-size:13px;
  color:var(--muted);
}
.kpi .value{
  margin-top:6px;
  font-size:28px;
  font-weight:900;
}

/* CARDS */
.card{
  background:#fff;
  padding:20px;
  border-radius:var(--radius);
  box-shadow:0 10px 26px rgba(10,42,94,.08);
  margin-top:24px;
}

.request{
  border:1px solid #EEF1F6;
  padding:16px;
  border-radius:16px;
  margin-bottom:12px;
}

.actions{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-top:10px;
}

.actions button{
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:700;
  color:#fff;
  cursor:pointer;
}

.accept{background:var(--success)}
.refuse{background:var(--danger)}
.call{background:#6C5CE7}
.chat{background:var(--primary)}
</style>
</head>

<body>

<header>
  <div class="brand">
    <strong id="proName">‚Äî</strong>
    <small id="proMeta">‚Äî</small>
  </div>

  <div class="status">
    <div id="statusDot" class="dot"></div>
    <span id="statusText">Hors ligne</span>
  </div>

  <button class="notif-btn">
    üîî
    <span id="notifBadge" class="badge" style="display:none">0</span>
  </button>
</header>

<main>

<section class="kpis">
  <div class="kpi"><h4>Demandes</h4><div class="value" id="kpiPending">0</div></div>
  <div class="kpi"><h4>Actives</h4><div class="value" id="kpiActive">0</div></div>
  <div class="kpi"><h4>Termin√©es</h4><div class="value" id="kpiDone">0</div></div>
  <div class="kpi"><h4>Revenus</h4><div class="value" id="kpiRevenue">0</div></div>
</section>

<section class="card">
  <h3>üü° Demandes en attente</h3>
  <div id="pendingList"></div>
</section>

<section class="card">
  <h3>üü¢ Consultations actives</h3>
  <div id="activeList"></div>
</section>

</main>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, updateDoc,
  collection, query, where,
  onSnapshot, serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const proName=document.getElementById("proName");
const proMeta=document.getElementById("proMeta");
const statusDot=document.getElementById("statusDot");
const statusText=document.getElementById("statusText");
const notifBadge=document.getElementById("notifBadge");

const pendingList=document.getElementById("pendingList");
const activeList=document.getElementById("activeList");

const kpiPending=document.getElementById("kpiPending");
const kpiActive=document.getElementById("kpiActive");

onAuthStateChanged(auth, async(user)=>{
  if(!user) return location.href="/cizahealth/index.html";

  const userRef=doc(db,"users",user.uid);
  const snap=await getDoc(userRef);
  const p=snap.data();

  proName.textContent=p.fullName;
  proMeta.textContent=`${p.speciality} ‚Ä¢ ${p.province}`;

  /* ONLINE HEARTBEAT */
  setInterval(()=>{
    updateDoc(userRef,{lastOnlineAt:serverTimestamp()});
  },15000);

  onSnapshot(userRef,s=>{
    const last=s.data()?.lastOnlineAt?.toMillis?.();
    const online=last && Date.now()-last<30000;
    statusDot.classList.toggle("online",online);
    statusText.textContent=online?"En ligne":"Hors ligne";
  });

  /* NOTIFICATIONS */
  onSnapshot(
    query(collection(db,"notifications"),
      where("receiverId","==",user.uid),
      where("read","==",false)),
    snap=>{
      if(snap.size>0){
        notifBadge.style.display="block";
        notifBadge.textContent=snap.size;
      }else{
        notifBadge.style.display="none";
      }
    }
  );

  /* MATCHING PROVINCE */
  onSnapshot(
    query(collection(db,"requests"),
      where("status","==","pending"),
      where("province","==",p.province)
    ),
    snap=>{
      pendingList.innerHTML="";
      kpiPending.textContent=snap.size;

      snap.forEach(d=>{
        const r=d.data();
        const div=document.createElement("div");
        div.className="request";

        div.innerHTML=`
          <strong>${r.fullName}</strong><br>
          <small>${r.motif || ""}</small>
          <div class="actions">
            <button class="accept">Accepter</button>
            <button class="refuse">Refuser</button>
            <button disabled class="chat">Chat</button>
          </div>
        `;

        div.querySelector(".accept").onclick=async()=>{
          await updateDoc(doc(db,"requests",d.id),{
            status:"assigned",
            assignedProUid:user.uid,
            assignedProName:p.fullName,
            assignedAt:serverTimestamp()
          });
        };

        div.querySelector(".refuse").onclick=async()=>{
          await updateDoc(doc(db,"requests",d.id),{
            status:"refused",
            refusedBy:user.uid,
            refusedAt:serverTimestamp()
          });
        };

        pendingList.appendChild(div);
      });
    }
  );

  /* CONSULTATIONS ACTIVES */
  onSnapshot(
    query(collection(db,"requests"),
      where("assignedProUid","==",user.uid)
    ),
    snap=>{
      activeList.innerHTML="";
      let count=0;

      snap.forEach(d=>{
        const r=d.data();
        if(r.status==="assigned"||r.status==="in_call"){
          count++;

          const div=document.createElement("div");
          div.className="request";

          div.innerHTML=`
            <strong>Consultation</strong>
            <div class="actions">
              <button class="call">üìû</button>
              <button class="chat">üí¨</button>
              <button class="accept">üìù</button>
            </div>
          `;

          div.querySelector(".call").onclick=()=>{
            location.href=`/cizahealth/call.html?requestId=${d.id}`;
          };

          div.querySelector(".chat").onclick=()=>{
            location.href=`/cizahealth/chat.html?requestId=${d.id}`;
          };

          div.querySelector(".accept").onclick=()=>{
            location.href=`/cizahealth/report.html?requestId=${d.id}`;
          };

          activeList.appendChild(div);
        }
      });

      kpiActive.textContent=count;
    }
  );

});
</script>

</body>
</html>
