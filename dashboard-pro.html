<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CizaHealth+ | Dashboard Professionnel</title>

<style>
:root{
  --primary:#0E3A8A;
  --primary-dark:#0A2F6A;
  --success:#1B6B3A;
  --warning:#E67E22;
  --danger:#C0392B;
  --bg:#F4F7FB;
  --card:#FFFFFF;
  --text:#0A1A2F;
  --muted:#6B7A90;
  --radius:22px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
}

header{
  background:linear-gradient(90deg,var(--primary),var(--primary-dark));
  color:#fff;
  padding:16px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
}

.brand img{height:36px}

.status{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:700;
}

.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:red;
}

.dot.online{background:#2ecc71}

.notif-btn{
  position:relative;
  background:#fff;
  color:var(--primary);
  border:none;
  padding:8px 12px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
}

.badge{
  position:absolute;
  top:-6px;
  right:-6px;
  background:var(--danger);
  color:#fff;
  font-size:11px;
  padding:3px 7px;
  border-radius:999px;
}

main{
  padding:22px;
  max-width:1200px;
  margin:auto;
}

.card{
  background:#fff;
  border-radius:var(--radius);
  padding:20px;
  box-shadow:0 10px 26px rgba(10,42,94,.08);
  margin-top:20px;
}

.request{
  border:1px solid #EEF1F6;
  border-radius:18px;
  padding:16px;
  margin-bottom:12px;
}

.actions{
  margin-top:12px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}

.actions button{
  border:none;
  border-radius:12px;
  padding:10px;
  font-weight:700;
  color:#fff;
  cursor:pointer;
}

.accept{background:var(--success)}
.refuse{background:var(--danger)}
.call{background:#6C5CE7}
.chat{background:var(--primary)}
</style>
</head>

<body>

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/cizaimmo/cizahealth/main/9008F813-82B0-4A0C-8B18-00CA519A77CF.png">
    <div>
      <strong id="proName">‚Äî</strong><br>
      <small id="proMeta">‚Äî</small>
    </div>
  </div>

  <div class="status">
    <div id="statusDot" class="dot"></div>
    <span id="statusText">Hors ligne</span>
  </div>

  <button class="notif-btn">
    üîî
    <span id="notifBadge" class="badge" style="display:none">0</span>
  </button>
</header>

<main>

<div class="card">
  <h3>üü° Demandes en attente</h3>
  <div id="pendingList"></div>
</div>

<div class="card">
  <h3>üü¢ Consultations actives</h3>
  <div id="activeList"></div>
</div>

</main>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, updateDoc,
  collection, query, where,
  onSnapshot, serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const proName = document.getElementById("proName");
const proMeta = document.getElementById("proMeta");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const notifBadge = document.getElementById("notifBadge");
const pendingList = document.getElementById("pendingList");
const activeList = document.getElementById("activeList");

onAuthStateChanged(auth, async(user)=>{
  if(!user) return location.href="/cizahealth/index.html";

  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);
  const p = snap.data();

  proName.textContent = p.fullName || "Professionnel";
  proMeta.textContent = `${p.speciality || "M√©decin"} ‚Ä¢ ${p.province || ""}`;

  /* ONLINE */
  setInterval(()=>{
    updateDoc(userRef,{lastOnlineAt:serverTimestamp()});
  },15000);

  onSnapshot(userRef,s=>{
    const last=s.data()?.lastOnlineAt?.toMillis?.();
    const online=last && Date.now()-last<30000;
    statusDot.classList.toggle("online",online);
    statusText.textContent=online?"En ligne":"Hors ligne";
  });

  /* üîî NOTIFICATIONS */
  onSnapshot(
    query(collection(db,"notifications"),
      where("receiverId","==",user.uid),
      where("read","==",false)),
    snap=>{
      if(snap.size>0){
        notifBadge.style.display="block";
        notifBadge.textContent=snap.size;
      }else{
        notifBadge.style.display="none";
      }
    }
  );

  /* üü° MATCHING PAR PROVINCE */
  onSnapshot(
    query(collection(db,"requests"),
      where("status","==","pending"),
      where("province","==",p.province)
    ),
    snap=>{
      pendingList.innerHTML="";
      snap.forEach(d=>{
        const r=d.data();

        const div=document.createElement("div");
        div.className="request";

        div.innerHTML=`
          <strong>${r.fullName || "Patient"}</strong><br>
          <small>${r.province}</small>
          <div class="actions">
            <button class="accept">Accepter</button>
            <button class="refuse">Refuser</button>
            <button class="chat" disabled>Chat</button>
          </div>
        `;

        div.querySelector(".accept").onclick=async()=>{
          await updateDoc(doc(db,"requests",d.id),{
            status:"assigned",
            assignedProUid:user.uid,
            assignedProName:p.fullName,
            assignedAt:serverTimestamp()
          });
        };

        div.querySelector(".refuse").onclick=async()=>{
          await updateDoc(doc(db,"requests",d.id),{
            status:"refused",
            refusedBy:user.uid,
            refusedAt:serverTimestamp()
          });
        };

        pendingList.appendChild(div);
      });
    }
  );

  /* üü¢ CONSULTATIONS ACTIVES */
  onSnapshot(
    query(collection(db,"requests"),
      where("assignedProUid","==",user.uid)
    ),
    snap=>{
      activeList.innerHTML="";
      snap.forEach(d=>{
        const r=d.data();
        if(r.status==="assigned" || r.status==="in_call"){

          const div=document.createElement("div");
          div.className="request";

          div.innerHTML=`
            <strong>Consultation</strong><br>
            <small>Statut : ${r.status}</small>
            <div class="actions">
              <button class="call">üìû Appel</button>
              <button class="chat">üí¨ Chat</button>
              <button class="accept">üìù Rapport</button>
            </div>
          `;

          div.querySelector(".call").onclick=()=>{
            location.href=`/cizahealth/call.html?requestId=${d.id}`;
          };

          div.querySelector(".chat").onclick=()=>{
            location.href=`/cizahealth/chat.html?requestId=${d.id}`;
          };

          div.querySelector(".accept").onclick=()=>{
            location.href=`/cizahealth/report.html?requestId=${d.id}`;
          };

          activeList.appendChild(div);
        }
      });
    }
  );

});
</script>

</body>
</html>
