<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Dashboard Professionnel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#123c8a;
  --green:#1b6b3a;
  --red:#c0392b;
  --bg:#f4f7fb;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:22px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:1200px;
  margin:auto;
  min-height:100vh;
  background:#fff;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
header{
  position:sticky;
  top:0;
  z-index:20;
  background:#fff;
  border-bottom:1px solid #eef1f6;
  padding:18px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
}
.brand{
  display:flex;
  align-items:center;
  gap:14px;
}
.brand img{height:38px}
.brand strong{font-size:16px}
.brand span{font-size:12px;color:var(--muted)}
.topRight{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.status{
  padding:6px 14px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  border:1px solid #e6ebf5;
}
.status.available{background:#eaf6f0;color:var(--green)}
.status.busy{background:#eef4ff;color:#123c8a}
.status.suspended{background:#fdecea;color:var(--red)}

.logout{
  border:none;
  background:none;
  color:var(--red);
  font-weight:700;
  cursor:pointer;
}
.iconBtn{
  border:1px solid #e6ebf5;
  background:#fff;
  border-radius:12px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:700;
  color:var(--text);
}
.iconBtn:hover{background:#f7f9ff}
.badgeDot{
  min-width:22px;height:22px;padding:0 8px;
  border-radius:999px;
  background:#eef4ff;
  color:#123c8a;
  font-size:12px;
  font-weight:800;
  border:1px solid #d9e6ff;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

/* ===== CONTENT ===== */
.content{
  padding:26px;
  display:grid;
  gap:26px;
}

/* PROFIL */
.profileCard{
  background:#f9fbff;
  border:1px solid #e6ebf5;
  border-radius:18px;
  padding:18px;
}
.profileCard strong{font-size:16px}
.profileMeta{font-size:13px;color:var(--muted);margin-top:4px}

/* KPI */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:18px;
}
.kpi{
  background:#fff;
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(10,42,94,.08);
}
.kpi strong{font-size:22px}

/* CARDS */
.card{
  background:#fff;
  border-radius:var(--radius);
  padding:22px;
  box-shadow:0 10px 28px rgba(10,42,94,.08);
}
.card h3{margin:0 0 10px}
.smallMuted{font-size:12px;color:var(--muted);margin-top:6px}

.request{
  border:1px solid #eef1f6;
  border-radius:16px;
  padding:16px;
  margin-bottom:14px;
}
.request.busyBorder{border-color:#d9e6ff;background:#fbfdff}
.reqTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.reqTags{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:10px;
}
.tag{
  background:#f2f5fb;
  border:1px solid #e6ebf5;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  color:var(--muted);
}
.actions{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.actions button{
  padding:12px;
  border:none;
  border-radius:14px;
  font-weight:800;
  color:#fff;
  cursor:pointer;
}
.actions button:disabled{opacity:.6;cursor:not-allowed}
.audio{background:#123c8a}
.chat{background:#1b6b3a}
.close{background:#c0392b}

.notif{
  font-size:13px;
  padding:10px;
  border-bottom:1px dashed #eee;
  cursor:pointer;
}
.notif.unread{background:#eef4ff;font-weight:700}
.empty{font-size:14px;color:var(--muted)}

/* FOOTER */
footer{
  margin-top:auto;
  padding:20px;
  border-top:1px solid #eef1f6;
  text-align:center;
  font-size:12px;
  color:#6b7a90;
}

/* MODAL */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(10,26,47,.35);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:50;
}
.modal{
  width:min(720px,100%);
  background:#fff;
  border-radius:18px;
  box-shadow:0 18px 60px rgba(10,26,47,.25);
  overflow:hidden;
}
.modalHead{
  padding:16px 18px;
  border-bottom:1px solid #eef1f6;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.modalHead strong{font-size:15px}
.modalBody{padding:16px 18px}
.modalBody label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
.modalBody textarea{
  width:100%;
  border:1px solid #e6ebf5;
  border-radius:14px;
  padding:12px;
  min-height:120px;
  font-family:inherit;
  resize:vertical;
}
.modalBody input{
  width:100%;
  border:1px solid #e6ebf5;
  border-radius:14px;
  padding:12px;
  font-family:inherit;
}
.modalFoot{
  padding:14px 18px;
  border-top:1px solid #eef1f6;
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.btn{
  border:none;
  border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  cursor:pointer;
}
.btnGhost{background:#f2f5fb;color:#0a1a2f;border:1px solid #e6ebf5}
.btnDanger{background:var(--red);color:#fff}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/cizaimmo/cizahealth/main/9008F813-82B0-4A0C-8B18-00CA519A77CF.png" alt="CizaHealth+">
    <div>
      <strong>CizaHealth+</strong><br>
      <span>Dashboard professionnel</span>
    </div>
  </div>

  <div class="topRight">
    <button class="iconBtn" id="markAllReadBtn" title="Marquer toutes les notifications comme lues">üîî <span id="unreadCount" class="badgeDot">0</span></button>
    <span class="status available" id="proStatus">Disponible</span>
    <button class="logout" id="logoutBtn">D√©connexion</button>
  </div>
</header>

<div class="content">

  <div class="profileCard">
    <strong id="proName">‚Äî</strong>
    <div class="profileMeta" id="proMeta">‚Äî</div>
    <div class="profileMeta" id="proProvince">‚Äî</div>
  </div>

  <div class="kpis">
    <div class="kpi">Consultations aujourd‚Äôhui<br><strong id="kpiToday">0</strong></div>
    <div class="kpi">Demandes actives<br><strong id="kpiWaiting">0</strong></div>
    <div class="kpi">Revenus estim√©s<br><strong id="kpiRevenue">0 BIF</strong></div>
  </div>

  <div class="card" id="activeCard">
    <h3>Demandes assign√©es</h3>
    <div class="smallMuted">‚ÄúD√©marrer‚Äù passe en consultation ‚Ä¢ ‚ÄúChat‚Äù cr√©e un chat MVP ‚Ä¢ ‚ÄúCl√¥turer‚Äù exige une note + cr√©e transaction + audit.</div>
    <div id="requestsList" class="empty">Chargement‚Ä¶</div>
  </div>

  <div class="card">
    <h3>Historique des consultations</h3>
    <div class="smallMuted">Liste des demandes cl√¥tur√©es (lecture seule).</div>
    <div id="historyList" class="empty">Chargement‚Ä¶</div>
  </div>

  <div class="card" id="notifCard">
    <h3>Notifications</h3>
    <div class="smallMuted">Clique une notification pour la marquer comme lue. Si elle contient une demande, elle s‚Äôouvre automatiquement.</div>
    <div id="notificationsList" class="empty">Aucune notification</div>
  </div>

</div>

<footer>
  ¬© 2026 <strong>CizaHealth+</strong> ‚Äî CIZA GROUP<br>
  Plateforme professionnelle de sant√© ‚Ä¢ Acc√®s s√©curis√© ‚Ä¢ Donn√©es confidentielles
</footer>

</div>

<!-- MODAL CLOTURE -->
<div class="modalBack" id="closeModalBack">
  <div class="modal">
    <div class="modalHead">
      <strong>Cl√¥turer la demande</strong>
      <button class="btn btnGhost" id="closeModalX">Fermer</button>
    </div>
    <div class="modalBody">
      <div id="closeModalSummary" class="smallMuted">‚Äî</div>

      <label>R√©sum√© / Note de consultation (obligatoire)</label>
      <textarea id="closeNote" placeholder="R√©sum√© clair : sympt√¥mes, constat, recommandation, orientation, etc."></textarea>

      <label>Montant √† enregistrer (BIF) ‚Äî optionnel</label>
      <input id="closeAmount" type="number" min="0" placeholder="Ex: 5000">

      <div class="smallMuted">Une transaction + un audit log seront cr√©√©s. Patient notifi√© si patientUid existe dans la demande.</div>
    </div>
    <div class="modalFoot">
      <button class="btn btnGhost" id="closeModalCancel">Annuler</button>
      <button class="btn btnDanger" id="closeModalConfirm">Confirmer la cl√¥ture</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, collection, query, where,
  onSnapshot, updateDoc, addDoc, serverTimestamp, orderBy,
  setDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

logoutBtn.onclick=async()=>{
  await signOut(auth);
  location.href="/cizahealth/index.html";
};

const todayStart = new Date(); todayStart.setHours(0,0,0,0);

function setProStatus(mode){
  // mode: available | busy | suspended
  if(mode==="suspended"){
    proStatus.textContent="Suspendu";
    proStatus.className="status suspended";
    return;
  }
  if(mode==="busy"){
    proStatus.textContent="En consultation";
    proStatus.className="status busy";
    return;
  }
  proStatus.textContent="Disponible";
  proStatus.className="status available";
}

async function audit(actor, action, target, extra={}){
  await addDoc(collection(db,"auditLogs"),{ actor, action, target, extra, at:serverTimestamp() });
}
async function notify(fromUid, toUid, title, message, requestId=null){
  if(!toUid) return;
  await addDoc(collection(db,"notifications"),{
    toUid, title, message,
    requestId: requestId || null,
    read:false,
    createdAt:serverTimestamp(),
    createdBy:fromUid
  });
}

function safeTxt(x){ return (x==null) ? "‚Äî" : String(x); }
function money(x){
  const n = Number(x||0);
  if(!Number.isFinite(n)) return "0";
  return String(Math.round(n));
}

function getPatientUidFromRequest(r){
  return r.patientUid || r.patientId || r.clientUid || r.userUid || null;
}

let currentUser=null;
let currentPro=null;

const patientCache=new Map();
async function getPatient(uid){
  if(!uid) return null;
  if(patientCache.has(uid)) return patientCache.get(uid);
  try{
    const s = await getDoc(doc(db,"users",uid));
    const val = s.exists() ? s.data() : null;
    patientCache.set(uid,val);
    return val;
  }catch(e){
    patientCache.set(uid,null);
    return null;
  }
}

/* MODAL CLOTURE */
let pendingClose={requestId:null, requestData:null};

function openCloseModal(requestId, requestData){
  pendingClose={requestId, requestData};
  closeNote.value="";
  closeAmount.value="";

  const r = requestData || {};
  const suggested = (r.proAmount ?? r.pricePro ?? r.proFee ?? r.amount ?? r.price ?? 5000);
  closeAmount.value = Number(suggested||0);

  const base=[
    `Demande : ${requestId}`,
    `Service : ${r.serviceType||r.type||"‚Äî"}`,
    `Statut : ${r.status||"‚Äî"}`,
    `Province : ${r.province||"‚Äî"}`
  ];
  const puid = getPatientUidFromRequest(r);
  if(puid) base.push(`Patient UID : ${puid}`);
  closeModalSummary.textContent = base.join(" ‚Ä¢ ");

  closeModalBack.style.display="flex";
}
function closeCloseModal(){
  closeModalBack.style.display="none";
  pendingClose={requestId:null, requestData:null};
}
closeModalX.onclick=closeCloseModal;
closeModalCancel.onclick=closeCloseModal;
closeModalBack.addEventListener("click",(e)=>{ if(e.target===closeModalBack) closeCloseModal(); });

/* Marquer tout lu (sans snapshot infini) */
markAllReadBtn.onclick = async ()=>{
  if(!currentUser) return;
  try{
    const q = query(collection(db,"notifications"),where("toUid","==",currentUser.uid),where("read","==",false));
    const snap = await getDocs(q);
    for(const d of snap.docs){
      await updateDoc(doc(db,"notifications",d.id),{read:true});
    }
  }catch(e){
    alert("Impossible de marquer tout comme lu.");
  }
};

onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="/cizahealth/index.html";
  currentUser=user;

  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()) return document.body.innerHTML="Acc√®s refus√©";

  const pro=snap.data();
  currentPro=pro;

  /* S√©curit√© m√©tier */
  if(!["doctor","nurse","aide"].includes(pro.role) || pro.status!=="validated" || !pro.documentsVerified || pro.accountStatus==="suspended"){
    setProStatus("suspended");
    document.body.innerHTML="<h2 style='padding:40px'>Compte non autoris√©</h2>";
    return;
  }

  proName.textContent = pro.fullName || "‚Äî";
  proMeta.textContent = `${pro.specialty||"‚Äî"} ‚Ä¢ ${pro.proId||"‚Äî"}`;
  proProvince.textContent = `Province : ${pro.province||"‚Äî"}`;

  /* REQUESTS (actives) + KPI + statut dynamique */
  const rq = query(collection(db,"requests"), where("assignedProUid","==",user.uid));
  const requestDomMap = new Map(); // requestId -> element

  onSnapshot(rq, async (s)=>{
    requestsList.innerHTML="";
    requestDomMap.clear();

    let today=0, active=0, anyBusy=false;

    // Active list
    for(const d of s.docs){
      const r=d.data();

      const closedToday =
        r.status==="closed" &&
        r.closedAt?.toDate &&
        r.closedAt.toDate() >= todayStart;
      if(closedToday) today++;

      const isActive = ["assigned","in_progress"].includes(r.status);
      if(isActive) active++;

      if(r.status==="in_progress") anyBusy=true;

      if(isActive){
        const patientUid = getPatientUidFromRequest(r);
        const patient = await getPatient(patientUid);

        const patientName = patient?.fullName || patient?.name || (patientUid ? ("UID: "+patientUid.slice(0,8)+"‚Ä¶") : "‚Äî");
        const service = r.serviceType || r.type || "‚Äî";
        const province = r.province || pro.province || "‚Äî";
        const created = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "‚Äî";

        const div=document.createElement("div");
        div.className="request"+(r.status==="in_progress"?" busyBorder":"");
        div.dataset.requestId = d.id;

        div.innerHTML=`
<div class="reqTop">
  <div>
    <strong>Service</strong> ‚Äî ${safeTxt(service)}<br>
    <strong>Patient</strong> ‚Äî ${safeTxt(patientName)}
  </div>
  <div class="tag">${r.status==="in_progress"?"üü¶ En cours":"üü© Assign√©e"}</div>
</div>

<div class="reqTags">
  <span class="tag">üìå ${safeTxt(province)}</span>
  <span class="tag">üóìÔ∏è ${safeTxt(created)}</span>
  ${patient?.phone?`<span class="tag">üìû ${safeTxt(patient.phone)}</span>`:""}
  ${patient?.email?`<span class="tag">‚úâÔ∏è ${safeTxt(patient.email)}</span>`:""}
</div>

<div class="actions">
  <button class="audio">${r.status==="in_progress"?"En cours":"D√©marrer"}</button>
  <button class="chat">Chat</button>
  <button class="close">Cl√¥turer</button>
</div>
`;

        // S√©curit√© double clic
        const btnStart = div.querySelector(".audio");
        const btnChat  = div.querySelector(".chat");
        const btnClose = div.querySelector(".close");

        if(r.status==="in_progress"){
          btnStart.disabled=true;
        }

        btnStart.onclick = async ()=>{
          try{
            btnStart.disabled=true;
            await updateDoc(doc(db,"requests",d.id),{
              status:"in_progress",
              startedAt: serverTimestamp(),
              lastUpdatedAt: serverTimestamp()
            });
            await audit(user.uid,"start_request",d.id,{status:"in_progress"});
          }catch(e){
            btnStart.disabled=false;
            alert("Impossible de d√©marrer la demande.");
          }
        };

        btnChat.onclick = async ()=>{
          try{
            btnChat.disabled=true;
            const chatId = `CHAT_${d.id}_${user.uid}`;
            await setDoc(doc(db,"chats",chatId),{
              chatId,
              requestId: d.id,
              proUid: user.uid,
              patientUid: patientUid || null,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
              status:"active"
            },{merge:true});
            await audit(user.uid,"open_chat",chatId,{requestId:d.id});

            // Si tu cr√©es chat.html plus tard, √ßa s‚Äôouvrira direct
            // Sinon, fallback
            const url = `chat.html?chatId=${encodeURIComponent(chatId)}&requestId=${encodeURIComponent(d.id)}`;
            try{
              location.href = url;
            }catch(_){
              alert("Chat pr√™t. ID: "+chatId);
            }
          }catch(e){
            btnChat.disabled=false;
            alert("Impossible d‚Äôouvrir le chat.");
          }
        };

        btnClose.onclick = ()=>{
          openCloseModal(d.id, r);
        };

        requestsList.appendChild(div);
        requestDomMap.set(d.id, div);
      }
    }

    kpiToday.textContent=today;
    kpiWaiting.textContent=active;

    if(!requestsList.innerHTML){
      requestsList.innerHTML='<div class="empty">Aucune demande active</div>';
    }

    // Statut pro dynamique
    setProStatus(anyBusy ? "busy" : "available");
  });

  /* Historique (cl√¥tur√©es) */
  onSnapshot(rq, async (s)=>{
    historyList.innerHTML="";
    let has=false;

    for(const d of s.docs){
      const r=d.data();
      if(r.status!=="closed") continue;
      has=true;

      const service = r.serviceType || r.type || "‚Äî";
      const closed = r.closedAt?.toDate ? r.closedAt.toDate().toLocaleString() : "‚Äî";

      const div=document.createElement("div");
      div.className="request";
      div.innerHTML=`
<strong>Service</strong> ‚Äî ${safeTxt(service)}<br>
<span class="tag">‚úÖ Cl√¥tur√©e</span>
<span class="tag">üóìÔ∏è ${safeTxt(closed)}</span>
`;

      historyList.appendChild(div);
    }

    if(!has) historyList.innerHTML='<div class="empty">Aucune consultation cl√¥tur√©e</div>';
  });

  /* CONFIRM CLOSE (modal) */
  closeModalConfirm.onclick = async ()=>{
    const requestId = pendingClose.requestId;
    const r = pendingClose.requestData;

    if(!requestId || !r) return closeCloseModal();

    const note = (closeNote.value||"").trim();
    if(!note) return alert("Note obligatoire avant cl√¥ture.");

    const amount = Number(closeAmount.value||0);
    const safeAmount = Number.isFinite(amount) ? amount : 0;

    const ok = confirm("Confirmer la cl√¥ture ? Cette action est enregistr√©e.");
    if(!ok) return;

    closeModalConfirm.disabled=true;

    try{
      // Update request
      await updateDoc(doc(db,"requests",requestId),{
        status:"closed",
        closedAt: serverTimestamp(),
        closedBy: currentUser.uid,
        closeNote: note,
        lastUpdatedAt: serverTimestamp()
      });

      // Transaction
      const suggested = (r.proAmount ?? r.pricePro ?? r.proFee ?? r.amount ?? r.price ?? 5000);
      const finalAmount = safeAmount>0 ? safeAmount : Number(suggested||0) || 0;

      const patientUid = getPatientUidFromRequest(r);

      await addDoc(collection(db,"transactions"),{
        requestId,
        proUid: currentUser.uid,
        patientUid: patientUid || null,
        amount: finalAmount,
        currency:"BIF",
        status:"success",
        method: r.paymentMethod || "wallet",
        createdAt: serverTimestamp(),
        meta:{
          specialty: currentPro?.specialty || null,
          province: currentPro?.province || null
        }
      });

      // Audit
      await audit(currentUser.uid,"close_request",requestId,{
        amount: finalAmount,
        notePreview: note.slice(0,140)
      });

      // Notify patient (optional)
      if(patientUid){
        await notify(currentUser.uid, patientUid, "Consultation cl√¥tur√©e", "Votre consultation a √©t√© cl√¥tur√©e. Merci.", requestId);
      }

      closeCloseModal();
    }catch(e){
      alert("Impossible de cl√¥turer la demande.");
    }finally{
      closeModalConfirm.disabled=false;
    }
  };

  /* Revenus (success) */
  onSnapshot(query(collection(db,"transactions"),where("proUid","==",user.uid)), s=>{
    let total=0;
    s.forEach(d=>{
      const t=d.data();
      if(t.status && t.status!=="success") return;
      total += Number(t.amount||0);
    });
    kpiRevenue.textContent = money(total)+" BIF";
  });

  /* Notifications (unread count + read on click + jump to request) */
  const notifsQ = query(collection(db,"notifications"),where("toUid","==",user.uid),orderBy("createdAt","desc"));

  onSnapshot(notifsQ, s=>{
    notificationsList.innerHTML="";
    let unread=0;

    if(s.empty){
      notificationsList.innerHTML='<div class="empty">Aucune notification</div>';
      unreadCount.textContent="0";
      return;
    }

    s.forEach(d=>{
      const n=d.data();
      if(!n.read) unread++;

      const div=document.createElement("div");
      div.className="notif"+(n.read?"":" unread");

      const when = n.createdAt?.toDate ? n.createdAt.toDate().toLocaleString() : "";
      div.innerHTML=`<strong>${n.title||"Info"}</strong><br>${n.message||""}${when?`<div class="smallMuted">${when}</div>`:""}`;

      div.onclick = async ()=>{
        try{
          await updateDoc(doc(db,"notifications",d.id),{read:true});
        }catch(e){}

        // Si notification li√©e √† requestId ‚Üí focus
        const rid = n.requestId || null;
        if(rid){
          // Scroll vers la carte demande si pr√©sente
          const el = document.querySelector(`[data-request-id="${rid}"]`);
          if(el){
            el.scrollIntoView({behavior:"smooth",block:"center"});
            el.style.boxShadow="0 0 0 3px rgba(18,60,138,.15)";
            setTimeout(()=>{ el.style.boxShadow=""; }, 1200);
          }
        }
      };

      notificationsList.appendChild(div);
    });

    unreadCount.textContent = String(unread);
  });

});
</script>

</body>
</html>
