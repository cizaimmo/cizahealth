<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Dashboard Professionnel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#123c8a;
  --green:#1b6b3a;
  --red:#c0392b;
  --orange:#e67e22;
  --bg:#f4f7fb;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:20px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;background:var(--bg);color:var(--text)}
.app{max-width:1200px;margin:auto;min-height:100vh;background:#fff;display:flex;flex-direction:column}
header{background:linear-gradient(90deg,#123c8a,#0b2c66);color:#fff;padding:16px 22px;display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:48px;width:48px;border-radius:50%;object-fit:cover}
.status{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700}
.dot{width:10px;height:10px;border-radius:50%;background:#e74c3c}
.content{padding:24px;display:grid;gap:24px}
.card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:0 10px 28px rgba(10,42,94,.08)}
.request{border:1px solid #eef1f6;border-radius:16px;padding:16px;margin-bottom:14px}
.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
.actions button{padding:12px;border:none;border-radius:14px;font-weight:800;color:#fff;cursor:pointer}
.accept{background:var(--green)}
.refuse{background:var(--red)}
.chat{background:#123c8a}
.call{background:#6c5ce7}
.report{background:#0b2c66}
.empty{color:var(--muted);font-size:14px}
.badge{background:#e74c3c;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;display:none}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <img id="proPhoto"
      src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    <div>
      <strong id="proName">â€”</strong><br>
      <span id="proMeta">â€”</span>
    </div>
  </div>

  <div style="display:flex;align-items:center;gap:12px">
    <div class="status">
      <span id="onlineDot" class="dot"></span>
      <span id="onlineText">Hors ligne</span>
    </div>

    <button id="notifBtn" style="position:relative;border:none;background:#fff;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer">
      ğŸ””
      <span id="notifCount" class="badge">0</span>
    </button>

    <button id="logoutBtn">DÃ©connexion</button>
  </div>
</header>

<div class="content">

<div class="card">
  <h3>ğŸŸ¡ RequÃªtes en attente</h3>
  <div id="pendingList" class="empty">Chargementâ€¦</div>
</div>

<div class="card">
  <h3>ğŸŸ¢ RequÃªtes acceptÃ©es</h3>
  <div id="assignedList" class="empty">Aucune demande</div>
</div>

<div class="card">
  <h3>ğŸ”” Notifications</h3>
  <div id="notificationsList" class="empty">Aucune notification</div>
</div>

</div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, query, where, onSnapshot,
  doc, updateDoc, serverTimestamp,
  getDoc, addDoc
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const proPhoto=document.getElementById("proPhoto");
const proName=document.getElementById("proName");
const proMeta=document.getElementById("proMeta");
const onlineDot=document.getElementById("onlineDot");
const onlineText=document.getElementById("onlineText");
const notifCount=document.getElementById("notifCount");
const notificationsList=document.getElementById("notificationsList");
const pendingList=document.getElementById("pendingList");
const assignedList=document.getElementById("assignedList");

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  location.href="/cizahealth/index.html";
};

onAuthStateChanged(auth, async(user)=>{
if(!user) return location.href="/cizahealth/index.html";

const snap=await getDoc(doc(db,"users",user.uid));
const p=snap.data();

proName.textContent=p.fullName||"MÃ©decin";
proMeta.textContent=`${p.speciality||"MÃ©decin"} â€¢ ${p.province||""}`;
if(p.photoURL) proPhoto.src=p.photoURL;

/* ONLINE */
setInterval(()=>{
updateDoc(doc(db,"users",user.uid),{lastOnlineAt:serverTimestamp()});
},15000);

onSnapshot(doc(db,"users",user.uid),s=>{
const last=s.data()?.lastOnlineAt?.toMillis?.();
const online=last && Date.now()-last<30000;
onlineDot.style.background=online?"#2ecc71":"#e74c3c";
onlineText.textContent=online?"En ligne":"Hors ligne";
});

/* PENDING PROVINCE */
onSnapshot(query(collection(db,"requests"),
where("status","==","pending"),
where("province","==",p.province)),
snap=>{
pendingList.innerHTML="";
if(snap.empty){pendingList.innerHTML='<div class="empty">Aucune requÃªte</div>';return;}

snap.forEach(d=>{
const r=d.data();
const div=document.createElement("div");
div.className="request";
div.innerHTML=`
<strong>${r.fullName||"Patient"}</strong>
<div class="actions">
<button class="accept">Accepter</button>
<button class="refuse">Refuser</button>
<button class="chat" disabled>Chat</button>
</div>`;

div.querySelector(".accept").onclick=async()=>{
await updateDoc(doc(db,"requests",d.id),{
status:"assigned",
assignedProUid:user.uid,
assignedProName:p.fullName,
assignedProSpeciality:p.speciality,
assignedProProvince:p.province,
assignedProPhoto:p.photoURL||"",
assignedAt:serverTimestamp()
});
};

div.querySelector(".refuse").onclick=async()=>{
await updateDoc(doc(db,"requests",d.id),{
status:"refused",
refusedBy:user.uid
});
};

pendingList.appendChild(div);
});
});

/* ASSIGNED */
onSnapshot(query(collection(db,"requests"),
where("assignedProUid","==",user.uid)),
snap=>{
assignedList.innerHTML="";
snap.forEach(d=>{
const r=d.data();
if(r.status==="assigned"){
const div=document.createElement("div");
div.className="request";
div.innerHTML=`
<strong>Consultation</strong>
<div class="actions">
<button class="call">ğŸ“ Appeler</button>
<button class="chat">ğŸ’¬ Chat</button>
<button class="report">ğŸ“ Rapport</button>
</div>`;
div.querySelector(".call").onclick=()=>{
location.href=`call.html?requestId=${d.id}`;
};
assignedList.appendChild(div);
}
});
});

});
</script>
</body>
</html>
