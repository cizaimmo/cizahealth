<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Espace Pharmacie</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#123c8a;
  --blue-dark:#0b2c66;
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#6b7a90;
  --radius:20px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
}
.app{
  max-width:900px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:white;
  padding:18px;
}
header strong{font-size:16px}
.content{padding:20px}
.card{
  background:white;
  padding:18px;
  border-radius:var(--radius);
  margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
}
input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #e6ebf5;
  margin-top:10px;
}
button{
  margin-top:12px;
  padding:12px;
  border:none;
  border-radius:14px;
  background:var(--blue);
  color:white;
  font-weight:600;
  cursor:pointer;
}
.muted{color:var(--muted);font-size:13px}
.success{color:green;font-weight:600}
.error{color:#b00020;font-weight:600}
.footer{
  margin-top:auto;
  text-align:center;
  padding:18px;
  font-size:12px;
  color:#777;
}
video{
  width:100%;
  border-radius:14px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="app">

<header>
<strong id="pharmacyName">Pharmacie</strong>
</header>

<div class="content">

<div class="card">
<h3>Scanner ordonnance</h3>

<input id="manualCode" placeholder="Scanner ou entrer code RX">

<button id="validateBtn">Valider ordonnance</button>

<div id="result"></div>

<video id="preview" hidden></video>
<button id="startScan">Scanner avec caméra</button>

</div>

<div class="card">
<h3>Ordonnances en attente</h3>
<div id="pendingList"></div>
</div>

</div>

<div class="footer">
© 2026 CizaHealth+ — Espace partenaire
</div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
collection, query, where, onSnapshot,
doc, getDoc, updateDoc, serverTimestamp, getDocs
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const pharmacyNameEl = document.getElementById("pharmacyName");
const manualCode = document.getElementById("manualCode");
const validateBtn = document.getElementById("validateBtn");
const result = document.getElementById("result");
const pendingList = document.getElementById("pendingList");

let currentUser;

onAuthStateChanged(auth, async(user)=>{
  if(!user) return location.href="login.html";
  currentUser = user;

  const snap = await getDoc(doc(db,"users",user.uid));
  const data = snap.data();

  if(data.role !== "pharmacy"){
    alert("Accès refusé");
    location.href="login.html";
    return;
  }

  pharmacyNameEl.innerText = data.pharmacyName || "Pharmacie";

  listenPending();
});

function listenPending(){
  const q = query(
    collection(db,"prescriptions"),
    where("assignedPharmacyUid","==",currentUser.uid),
    where("status","==","sent")
  );

  onSnapshot(q,(snap)=>{
    pendingList.innerHTML="";
    if(snap.empty){
      pendingList.innerHTML="<div class='muted'>Aucune ordonnance en attente</div>";
      return;
    }

    snap.forEach(docu=>{
      const r = docu.data();
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <b>Code :</b> ${r.code}<br>
        <b>Date :</b> ${r.createdAt?.toDate()?.toLocaleString() || "—"}
      `;
      pendingList.appendChild(div);
    });
  });
}

validateBtn.onclick = async()=>{
  const code = manualCode.value.trim().toUpperCase();
  if(!code) return;

  result.innerHTML="Vérification...";

  const q = query(
    collection(db,"prescriptions"),
    where("code","==",code),
    where("assignedPharmacyUid","==",currentUser.uid),
    where("status","==","sent")
  );

  const snap = await getDocs(q);

  if(snap.empty){
    result.innerHTML="<div class='error'>Ordonnance invalide ou non assignée</div>";
    return;
  }

  const docu = snap.docs[0];
  const data = docu.data();

  let medsHTML="";
  data.medications.forEach(m=>{
    medsHTML += `
      <div>
        <b>${m.name}</b><br>
        ${m.dosage} — ${m.posology} — ${m.duration}
      </div><br>
    `;
  });

  result.innerHTML=`
    <div class='success'>Ordonnance valide</div><br>
    ${medsHTML}
    <button id="confirmDispense">Confirmer délivrance</button>
  `;

  document.getElementById("confirmDispense").onclick = async()=>{
    await updateDoc(doc(db,"prescriptions",docu.id),{
      used:true,
      status:"dispensed",
      dispensedAt: serverTimestamp()
    });

    result.innerHTML="<div class='success'>Ordonnance délivrée</div>";
    manualCode.value="";
  };
};

</script>
</body>
</html>
