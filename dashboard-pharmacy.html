<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Espace Pharmacie</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#123c8a;
  --blue-dark:#0b2c66;
  --bg:#f4f7fb;
  --card:#ffffff;
  --muted:#6b7a90;
  --radius:20px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
}
.app{
  max-width:900px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:white;
  padding:18px;
}
header strong{font-size:16px}
.content{padding:20px}
.card{
  background:white;
  padding:18px;
  border-radius:var(--radius);
  margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
}
input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #e6ebf5;
  margin-top:10px;
}
button{
  margin-top:12px;
  padding:12px;
  border:none;
  border-radius:14px;
  background:var(--blue);
  color:white;
  font-weight:600;
  cursor:pointer;
}
.muted{color:var(--muted);font-size:13px}
.success{color:green;font-weight:600}
.error{color:#b00020;font-weight:600}
.footer{
  margin-top:auto;
  text-align:center;
  padding:18px;
  font-size:12px;
  color:#777;
}
video{
  width:100%;
  border-radius:14px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="app">

<header>
<strong id="pharmacyName">Pharmacie</strong>
</header>

<div class="content">

<div class="card">
<h3>Scanner ordonnance</h3>

<input id="manualCode" placeholder="Scanner ou entrer code RX">

<button id="validateBtn">Valider ordonnance</button>

<div id="result"></div>

<video id="preview" hidden playsinline></video>
<button id="startScan">Scanner avec cam√©ra</button>

</div>

<div class="card">
<h3>Ordonnances en attente</h3>
<div id="pendingList"></div>
</div>

</div>

<div class="footer">
¬© 2026 CizaHealth+ ‚Äî Espace partenaire
</div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
collection, query, where, onSnapshot,
doc, getDoc, updateDoc, serverTimestamp, getDocs
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const pharmacyNameEl = document.getElementById("pharmacyName");
const manualCode = document.getElementById("manualCode");
const validateBtn = document.getElementById("validateBtn");
const result = document.getElementById("result");
const pendingList = document.getElementById("pendingList");

const preview = document.getElementById("preview");
const startScanBtn = document.getElementById("startScan");

let currentUser;
let scanStream = null;
let scanTimer = null;

onAuthStateChanged(auth, async(user)=>{
  if(!user) return location.href="login.html";
  currentUser = user;

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()){
    alert("Profil introuvable");
    location.href="login.html";
    return;
  }

  const data = snap.data();

  if(data.role !== "pharmacy"){
    alert("Acc√®s refus√©");
    location.href="login.html";
    return;
  }

  // ‚úÖ IMPORTANT : Firestore utilise fullName (pas pharmacyName)
  pharmacyNameEl.innerText = data.fullName || "Pharmacie partenaire";

  listenPending();
});

function listenPending(){
  const q = query(
    collection(db,"prescriptions"),
    where("assignedPharmacyUid","==",currentUser.uid),
    where("status","==","sent")
  );

  onSnapshot(q,(snap)=>{
    pendingList.innerHTML="";
    if(snap.empty){
      pendingList.innerHTML="<div class='muted'>Aucune ordonnance en attente</div>";
      return;
    }

    snap.forEach(docu=>{
      const r = docu.data();
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <b>Code :</b> ${r.code || "‚Äî"}<br>
        <b>Date :</b> ${r.createdAt?.toDate?.().toLocaleString?.() || "‚Äî"}
      `;
      pendingList.appendChild(div);
    });
  });
}

validateBtn.onclick = async()=>{
  const code = manualCode.value.trim().toUpperCase();
  if(!code) return;

  result.innerHTML="V√©rification...";

  const q = query(
    collection(db,"prescriptions"),
    where("code","==",code),
    where("assignedPharmacyUid","==",currentUser.uid),
    where("status","==","sent")
  );

  const snap = await getDocs(q);

  if(snap.empty){
    result.innerHTML="<div class='error'>Ordonnance invalide ou non assign√©e</div>";
    return;
  }

  const docu = snap.docs[0];
  const data = docu.data();

  const meds = Array.isArray(data.medications) ? data.medications : [];

  let medsHTML="";
  if(meds.length === 0){
    medsHTML = "<div class='muted'>Aucun m√©dicament list√©.</div><br>";
  }else{
    meds.forEach(m=>{
      medsHTML += `
        <div>
          <b>${(m && m.name) ? m.name : "‚Äî"}</b><br>
          ${(m && m.dosage) ? m.dosage : "‚Äî"} ‚Äî ${(m && m.posology) ? m.posology : "‚Äî"} ‚Äî ${(m && m.duration) ? m.duration : "‚Äî"}
        </div><br>
      `;
    });
  }

  result.innerHTML=`
    <div class='success'>Ordonnance valide</div><br>
    ${medsHTML}
    <button id="confirmDispense">Confirmer d√©livrance</button>
  `;

  document.getElementById("confirmDispense").onclick = async()=>{
    await updateDoc(doc(db,"prescriptions",docu.id),{
      used:true,
      status:"dispensed",
      dispensedAt: serverTimestamp()
    });

    result.innerHTML="<div class='success'>Ordonnance d√©livr√©e</div>";
    manualCode.value="";
  };
};

/* =========================
   üì∑ SCAN QR CAMERA (sans donn√©es sensibles)
   - Le QR contient seulement un texte (ex: RX-XXXXXX)
   - On remplit manualCode puis tu valides
   ========================= */

async function stopScan(){
  try{
    if(scanTimer){
      clearInterval(scanTimer);
      scanTimer = null;
    }
    if(scanStream){
      scanStream.getTracks().forEach(t=>t.stop());
      scanStream = null;
    }
    preview.hidden = true;
  }catch(e){}
}

async function startScan(){
  result.innerHTML = "<div class='muted'>Ouverture cam√©ra‚Ä¶</div>";

  // BarcodeDetector: Chrome/Android OK. Sinon fallback manuel.
  if(!("BarcodeDetector" in window)){
    result.innerHTML = "<div class='error'>Scan cam√©ra non support√© ici. Utilise la saisie/scanner manuel.</div>";
    return;
  }

  const detector = new BarcodeDetector({ formats: ["qr_code"] });

  try{
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });

    preview.srcObject = scanStream;
    preview.hidden = false;
    await preview.play();

    result.innerHTML = "<div class='muted'>Scannez le QR‚Ä¶</div>";

    scanTimer = setInterval(async ()=>{
      try{
        const barcodes = await detector.detect(preview);
        if(barcodes && barcodes.length){
          const raw = (barcodes[0].rawValue || "").trim();
          if(raw){
            manualCode.value = raw.toUpperCase();
            await stopScan();
            result.innerHTML = "<div class='success'>QR d√©tect√©. Cliquez sur ‚ÄúValider ordonnance‚Äù.</div>";
          }
        }
      }catch(e){}
    }, 350);

  }catch(err){
    console.error(err);
    result.innerHTML = "<div class='error'>Acc√®s cam√©ra refus√© ou indisponible.</div>";
    await stopScan();
  }
}

startScanBtn.onclick = async()=>{
  // toggle simple
  if(scanStream){
    await stopScan();
    result.innerHTML = "<div class='muted'>Scan arr√™t√©.</div>";
    return;
  }
  await startScan();
};

// Stop scan when leaving page
window.addEventListener("beforeunload", stopScan);
</script>
</body>
</html>
