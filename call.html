<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>CizaHealth+ | Consultation s√©curis√©e</title>

<style>
/* ===== DESIGN INCHANG√â ===== */
:root{
  --primary:#0E3A8A;
  --primary-dark:#0A2F6A;
  --bg:#F4F7FB;
  --card:#FFFFFF;
  --text:#0A1A2F;
  --muted:#6B7A90;
  --success:#1B6B3A;
  --danger:#C0392B;
  --radius:22px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#f4f7fb,#eef3fa);
  color:var(--text);
}
.app{min-height:100vh;display:flex;flex-direction:column}
header{
  background:linear-gradient(90deg,var(--primary),var(--primary-dark));
  color:#fff;padding:14px 18px;
  display:flex;gap:12px;align-items:center;
}
.back{cursor:pointer}
main{
  flex:1;
  max-width:1200px;
  margin:auto;
  padding:14px;
}
.vgrid{
  display:grid;
  gap:14px;
}
@media(min-width:900px){
  .vgrid{grid-template-columns:1fr 1fr}
}
.videoBox{
  background:#000;
  aspect-ratio:16/10;
  border-radius:22px;
  overflow:hidden;
}
video{width:100%;height:100%;object-fit:cover}
.controls{
  margin-top:14px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
button{
  padding:12px 16px;
  border-radius:14px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.primary{background:var(--success);color:#fff}
.blue{background:var(--primary);color:#fff}
.ghost{background:#eef3fb;color:var(--primary)}
.red{background:var(--danger);color:#fff}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="back" onclick="history.back()">‚Üê</div>
  <div>
    <strong>Consultation s√©curis√©e</strong><br>
    <span id="subLine">Connexion‚Ä¶</span>
  </div>
</header>

<main>

<div class="vgrid">
  <div class="videoBox">
    <video id="localVideo" autoplay playsinline muted></video>
  </div>
  <div class="videoBox">
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
</div>

<div class="controls">
  <button id="unlockBtn" class="ghost">üîä Activer le son</button>
  <button id="startBtn" class="primary">üìû D√©marrer</button>
  <button id="muteBtn" class="blue">üéôÔ∏è Muet</button>
  <button id="hangBtn" class="red">‚õî Quitter</button>
</div>

</main>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params=new URLSearchParams(location.search);
const requestId=params.get("requestId");

const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");
const startBtn=document.getElementById("startBtn");
const unlockBtn=document.getElementById("unlockBtn");
const muteBtn=document.getElementById("muteBtn");
const hangBtn=document.getElementById("hangBtn");
const subLine=document.getElementById("subLine");

let pc=null;
let localStream=null;
let role=null;
let audioUnlocked=false;
const callRef=doc(db,"callSessions",requestId);

unlockBtn.onclick=async()=>{
  audioUnlocked=true;
  remoteVideo.muted=false;
  try{await remoteVideo.play()}catch{}
  unlockBtn.disabled=true;
};

async function startMedia(){
  if(localStream) return;
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;
}

function createPC(){
  pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  pc.ontrack=e=>{
    remoteVideo.srcObject=e.streams[0];
    if(audioUnlocked){
      remoteVideo.muted=false;
      remoteVideo.play().catch(()=>{});
    }
  };
  pc.onicecandidate=e=>{
    if(e.candidate){
      updateDoc(callRef,{ice:JSON.stringify(e.candidate)});
    }
  };
}

onAuthStateChanged(auth,async user=>{
  if(!user) return location.href="/cizahealth/index.html";

  const reqSnap=await getDoc(doc(db,"requests",requestId));
  if(!reqSnap.exists()) return alert("Consultation introuvable");

  const r=reqSnap.data();
  const isPro=user.uid===r.assignedProUid;
  const isPatient=user.uid===r.patientUid;
  if(!isPro && !isPatient) return alert("Acc√®s refus√©");

  role=isPro?"pro":"patient";
  subLine.textContent=isPatient
    ?`Dr ${r.assignedProName} va vous appeler`
    :"Vous appelez le patient";

  if(isPatient){
    startBtn.disabled=true; // üîë PATIENT NE D√âMARRE PAS
  }

  await setDoc(callRef,{requestId},{merge:true});

  onSnapshot(callRef,async snap=>{
    const d=snap.data();

    // üîî PATIENT R√âPOND AUTOMATIQUEMENT
    if(d.offer && role==="patient" && !pc){
      createPC();
      await startMedia();
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      await pc.setRemoteDescription(JSON.parse(d.offer));
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await updateDoc(callRef,{answer:JSON.stringify(answer),status:"connected"});
    }

    // üîî PRO RE√áOIT ANSWER
    if(d.answer && role==="pro" && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(d.answer));
    }

    if(d.ice && pc){
      try{await pc.addIceCandidate(JSON.parse(d.ice))}catch{}
    }
  });

  startBtn.onclick=async()=>{
    createPC();
    await startMedia();
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    await updateDoc(callRef,{
      offer:JSON.stringify(offer),
      status:"calling",
      startedAt:serverTimestamp()
    });
  };

  muteBtn.onclick=()=>{
    if(!localStream) return;
    localStream.getAudioTracks().forEach(t=>t.enabled=!t.enabled);
  };

  hangBtn.onclick=async()=>{
    if(pc) pc.close();
    if(localStream) localStream.getTracks().forEach(t=>t.stop());
    await updateDoc(callRef,{status:"ended",endedAt:serverTimestamp()});
    history.back();
  };
});
</script>

</div>
</body>
</html>
