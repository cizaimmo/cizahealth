<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CizaHealth+ | Appel s√©curis√©</title>

<style>
:root{
  --primary:#123C8A;
  --primary-dark:#0B2C66;
  --success:#1B6B3A;
  --danger:#C0392B;
  --bg:#F4F7FB;
  --text:#0A1A2F;
  --radius:18px;
}

*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
}

.app{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

header{
  background:#ffffff;
  border-bottom:1px solid #E6ECF5;
  padding:14px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.brand img{height:34px}
.brand strong{font-size:14px}

.status{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  font-weight:700;
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:var(--danger);
}
.dot.online{background:#2ECC71}

main{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:14px;
  gap:12px;
}

.videos{
  flex:1;
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
}

video{
  width:100%;
  height:100%;
  background:#000;
  border-radius:var(--radius);
  object-fit:cover;
}

.controls{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}

.controls button{
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  color:#fff;
}

.start{background:var(--success)}
.hangup{background:var(--danger)}
.mute{background:var(--primary)}

@media(min-width:768px){
  .videos{
    grid-template-columns:2fr 1fr;
  }
}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/cizaimmo/cizahealth/main/9008F813-82B0-4A0C-8B18-00CA519A77CF.png">
    <strong>Appel s√©curis√©</strong>
  </div>

  <div class="status">
    <span id="callDot" class="dot"></span>
    <span id="callStatus">En attente</span>
  </div>
</header>

<main>
  <section class="videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </section>

  <section class="controls">
    <button id="startCallBtn" class="start">üìû D√©marrer</button>
    <button id="muteBtn" class="mute">üéôÔ∏è Muet</button>
    <button id="hangupBtn" class="hangup">‚õî Quitter</button>
  </section>
</main><script type="module">
/* =========================
BLOC 2 ‚Äî WEBRTC CORE
========================= */

let localStream = null;
let pc = null;
let isMuted = false;

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const startCallBtn = document.getElementById("startCallBtn");
const hangupBtn = document.getElementById("hangupBtn");
const muteBtn = document.getElementById("muteBtn");
const callStatus = document.getElementById("callStatus");
const callDot = document.getElementById("callDot");

/* =========================
WEBRTC CONFIG
========================= */
const rtcConfig = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

/* =========================
INIT PEER CONNECTION
========================= */
function createPeerConnection(){
  pc = new RTCPeerConnection(rtcConfig);

  pc.ontrack = (event)=>{
    remoteVideo.srcObject = event.streams[0];
  };

  pc.oniceconnectionstatechange = ()=>{
    if(pc.iceConnectionState === "connected"){
      callStatus.textContent = "Connect√©";
      callDot.classList.add("online");
    }
  };
}

/* =========================
START CALL (LOCAL MEDIA)
========================= */
startCallBtn.onclick = async ()=>{
  startCallBtn.disabled = true;
  callStatus.textContent = "Connexion‚Ä¶";

  localStream = await navigator.mediaDevices.getUserMedia({
    video:true,
    audio:true
  });

  localVideo.srcObject = localStream;

  createPeerConnection();

  localStream.getTracks().forEach(track=>{
    pc.addTrack(track, localStream);
  });
};

/* =========================
MUTE / UNMUTE
========================= */
muteBtn.onclick = ()=>{
  if(!localStream) return;

  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t=>{
    t.enabled = !isMuted;
  });

  muteBtn.textContent = isMuted ? "üîá Muet" : "üéôÔ∏è Muet";
};

/* =========================
HANGUP
========================= */
hangupBtn.onclick = ()=>{
  if(pc){
    pc.close();
    pc = null;
  }
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
  }

  remoteVideo.srcObject = null;
  localVideo.srcObject = null;

  callStatus.textContent = "Appel termin√©";
  callDot.classList.remove("online");
  startCallBtn.disabled = false;
};

/* =========================
FIN BLOC 2 ‚Äî WEBRTC CORE
========================= */
</script><script type="module">
/* =========================
BLOC 3 ‚Äî SIGNALISATION FIRESTORE
========================= */

import { auth, db } from "./firebase.js";
import {
  doc, setDoc, updateDoc, onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =========================
PARAMS
========================= */
const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");

if(!requestId){
  alert("requestId manquant");
}

/* =========================
REFS
========================= */
const callRef = doc(db,"callSessions",requestId);

/* =========================
INIT SESSION
========================= */
auth.onAuthStateChanged(async(user)=>{
  if(!user) return location.href="/cizahealth/index.html";

  // Cr√©e / merge la session d‚Äôappel
  await setDoc(callRef,{
    requestId,
    status:"idle",
    updatedAt: serverTimestamp()
  },{merge:true});
});

/* =========================
ICE CANDIDATES
========================= */
function bindIceCandidates(){
  pc.onicecandidate = async (event)=>{
    if(event.candidate){
      await updateDoc(callRef,{
        iceCandidate: JSON.stringify(event.candidate),
        updatedAt: serverTimestamp()
      });
    }
  };
}

/* =========================
START CALL (PRO INITIATE)
========================= */
startCallBtn.onclick = async ()=>{
  // (le BLOC 2 a d√©j√† cr√©√© pc + local tracks)
  bindIceCandidates();

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await updateDoc(callRef,{
    offer: JSON.stringify(offer),
    status:"calling",
    updatedAt: serverTimestamp()
  });

  callStatus.textContent = "Appel sortant‚Ä¶";
};

/* =========================
LISTEN SIGNALS
========================= */
onSnapshot(callRef, async (snap)=>{
  if(!snap.exists() || !pc) return;
  const data = snap.data();

  // RECEVOIR OFFER (PATIENT)
  if(data.offer && !pc.currentRemoteDescription){
    await pc.setRemoteDescription(JSON.parse(data.offer));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    await updateDoc(callRef,{
      answer: JSON.stringify(answer),
      status:"connected",
      updatedAt: serverTimestamp()
    });

    callStatus.textContent = "Connect√©";
    callDot.classList.add("online");
  }

  // RECEVOIR ANSWER (PRO)
  if(data.answer && pc.signalingState !== "stable"){
    await pc.setRemoteDescription(JSON.parse(data.answer));
    callStatus.textContent = "Connect√©";
    callDot.classList.add("online");
  }

  // RECEVOIR ICE
  if(data.iceCandidate){
    try{
      await pc.addIceCandidate(JSON.parse(data.iceCandidate));
    }catch(e){}
  }

  // FIN APPEL
  if(data.status === "ended"){
    callStatus.textContent = "Appel termin√©";
    callDot.classList.remove("online");
  }
});

/* =========================
HANGUP (SYNC)
========================= */
hangupBtn.onclick = async ()=>{
  if(pc){
    pc.close();
    pc = null;
  }
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
  }

  await updateDoc(callRef,{
    status:"ended",
    endedAt: serverTimestamp()
  });

  history.back();
};

/* =========================
FIN BLOC 3 ‚Äî SIGNALISATION
========================= */
</script><script type="module">
/* =========================
BLOC 4 ‚Äî STATUT & NOTIFS APPEL
========================= */

import { db } from "./firebase.js";
import {
  doc, updateDoc, onSnapshot, serverTimestamp, addDoc, collection
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =========================
PARAMS
========================= */
const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");
const callRef = doc(db,"callSessions",requestId);

/* =========================
UTIL ‚Äî SEND NOTIFICATION
========================= */
async function notify({title, body, receiverId, requestId}){
  await addDoc(collection(db,"notifications"),{
    title, body,
    receiverId,
    requestId,
    read:false,
    createdAt: serverTimestamp()
  });
}

/* =========================
OUTGOING CALL (PRO)
========================= */
async function notifyOutgoing(req){
  await notify({
    title:"Appel sortant",
    body:"Le professionnel d√©marre un appel",
    receiverId: req.patientUid,
    requestId
  });
}

/* =========================
INCOMING CALL (PATIENT)
========================= */
async function notifyIncoming(req){
  await notify({
    title:"Appel entrant",
    body:"Le professionnel vous appelle",
    receiverId: req.patientUid,
    requestId
  });
}

/* =========================
LISTEN CALL STATUS
========================= */
onSnapshot(callRef, async (snap)=>{
  if(!snap.exists()) return;
  const data = snap.data();

  if(data.status === "calling"){
    callStatus.textContent = "Sonnerie‚Ä¶";
    callDot.classList.remove("online");
  }

  if(data.status === "connected"){
    callStatus.textContent = "En appel";
    callDot.classList.add("online");
  }

  if(data.status === "ended"){
    callStatus.textContent = "Appel termin√©";
    callDot.classList.remove("online");
  }
});

/* =========================
HOOK START CALL
========================= */
const originalStart = startCallBtn.onclick;
startCallBtn.onclick = async ()=>{
  await originalStart?.();
  await updateDoc(callRef,{
    status:"calling",
    ringingAt: serverTimestamp()
  });
};

/* =========================
FIN BLOC 4 ‚Äî STATUT APPEL
========================= */
</script><script type="module">
/* =========================
BLOC 5 ‚Äî S√âCURIT√â & R√îLES
========================= */

import { auth, db } from "./firebase.js";
import {
  doc, getDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =========================
PARAMS
========================= */
const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");

/* =========================
UI ELEMENTS
========================= */
const startBtn = document.getElementById("startCallBtn");
const muteBtn = document.getElementById("muteBtn");
const hangBtn = document.getElementById("hangupBtn");

/* =========================
ROLE STATE
========================= */
let currentRole = null; // "pro" | "patient"

/* =========================
AUTH & ROLE CHECK
========================= */
auth.onAuthStateChanged(async (user)=>{
  if(!user || !requestId){
    alert("Acc√®s refus√©");
    return location.href="/cizahealth/index.html";
  }

  const reqSnap = await getDoc(doc(db,"requests",requestId));
  if(!reqSnap.exists()){
    alert("Consultation introuvable");
    return location.href="/cizahealth/index.html";
  }

  const req = reqSnap.data();

  if(user.uid === req.assignedTo){
    currentRole = "pro";
  }else if(user.uid === req.patientUid){
    currentRole = "patient";
  }else{
    alert("Non autoris√©");
    return location.href="/cizahealth/index.html";
  }

  /* =========================
  UI RULES
  ========================= */
  if(currentRole === "patient"){
    // Le patient ne d√©marre PAS l‚Äôappel
    startBtn.style.display = "none";
  }

  if(currentRole === "pro"){
    // Le pro d√©marre l‚Äôappel
    startBtn.style.display = "block";
  }
});

/* =========================
CALL STATUS GUARDS
========================= */
onSnapshot(doc(db,"callSessions",requestId),(snap)=>{
  if(!snap.exists()) return;
  const s = snap.data().status;

  // Boutons actifs seulement en appel
  if(s === "connected"){
    muteBtn.disabled = false;
    hangBtn.disabled = false;
  }else{
    muteBtn.disabled = true;
  }
});

/* =========================
FIN BLOC 5 ‚Äî S√âCURIT√â & R√îLES
========================= */
</script><!-- =========================
BLOC 6 ‚Äî FERMETURE FINALE
========================= -->

</body>
</html>

<!-- =========================
FIN ‚Äî CIZAHEALTH+
CALL.HTML ‚Äî APPEL WEBRTC
PRODUCTION READY
========================= -->
