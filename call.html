<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Appel Audio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#0a1a2f;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
}
.box{
  background:#123c8a;
  border-radius:20px;
  padding:24px;
  width:100%;
  max-width:420px;
  text-align:center;
}
h2{margin-top:0}
.status{margin:12px 0;font-weight:700}
.actions{
  display:flex;
  gap:12px;
  margin-top:20px;
}
button{
  flex:1;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
}
.accept{background:#2ecc71;color:#fff}
.hangup{background:#e74c3c;color:#fff}
</style>
</head>

<body>
<div class="box">
  <h2>ðŸ“ž Appel audio</h2>
  <div class="status" id="callStatus">Connexionâ€¦</div>

  <div class="actions">
    <button class="accept" id="acceptBtn">Accepter</button>
    <button class="hangup" id="hangupBtn">Raccrocher</button>
  </div>

  <audio id="remoteAudio" autoplay></audio>
</div>

<script type="module">
import { db } from "./firebase.js";
import {
  doc, collection, addDoc, onSnapshot, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const callId = params.get("callId");
const role = params.get("role"); // "pro" or "patient"

const callRef = doc(db,"callSessions",callId);
const signalsRef = collection(callRef,"signals");

const pc = new RTCPeerConnection({
  iceServers:[{urls:"stun:stun.l.google.com:19302"}]
});

const remoteAudio = document.getElementById("remoteAudio");

pc.ontrack = e => remoteAudio.srcObject = e.streams[0];

pc.onicecandidate = e=>{
  if(e.candidate){
    addDoc(signalsRef,{
      type:"ice",
      from:role,
      data:e.candidate,
      createdAt:serverTimestamp()
    });
  }
};

navigator.mediaDevices.getUserMedia({audio:true})
.then(stream=>{
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
});

onSnapshot(signalsRef,snap=>{
  snap.docChanges().forEach(async c=>{
    const s=c.doc.data();
    if(s.from===role) return;

    if(s.type==="offer"){
      await pc.setRemoteDescription(s.data);
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      addDoc(signalsRef,{
        type:"answer",
        from:role,
        data:answer,
        createdAt:serverTimestamp()
      });
      updateDoc(callRef,{status:"in_call",startedAt:serverTimestamp()});
    }

    if(s.type==="answer"){
      await pc.setRemoteDescription(s.data);
      updateDoc(callRef,{status:"in_call",startedAt:serverTimestamp()});
    }

    if(s.type==="ice"){
      await pc.addIceCandidate(s.data);
    }
  });
});

acceptBtn.onclick = async ()=>{
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  addDoc(signalsRef,{
    type:"offer",
    from:role,
    data:offer,
    createdAt:serverTimestamp()
  });
};

hangupBtn.onclick = async ()=>{
  await updateDoc(callRef,{
    status:"ended",
    endedAt:serverTimestamp()
  });
  pc.close();
  location.href="/";
};
</script>
</body>
</html>
