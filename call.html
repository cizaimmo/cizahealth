<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>CizaHealth+ | Consultation s√©curis√©e</title>

<style>
:root{
  --primary:#0E3A8A;
  --primary-dark:#0A2F6A;
  --bg:#F4F7FB;
  --card:#FFFFFF;
  --text:#0A1A2F;
  --muted:#6B7A90;
  --success:#1B6B3A;
  --danger:#C0392B;
  --radius:22px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#f4f7fb,#eef3fa);
  color:var(--text);
}

/* ===== LAYOUT ===== */
.app{min-height:100vh;display:flex;flex-direction:column}

header{
  position:sticky;top:0;z-index:50;
  background:linear-gradient(90deg,var(--primary),var(--primary-dark));
  color:#fff;padding:14px 18px;
  display:flex;align-items:center;gap:12px;
}
.back{
  width:38px;height:38px;border-radius:12px;
  background:rgba(255,255,255,.15);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.headMeta{flex:1;min-width:0}
.headMeta strong{display:block;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.headMeta span{font-size:12px;opacity:.9}

main{
  flex:1;
  max-width:1200px;
  margin:0 auto;
  padding:18px;
  display:grid;
  gap:14px;
}

.vgrid{display:grid;gap:14px}
@media(min-width:900px){.vgrid{grid-template-columns:1fr 1fr}}

.vcard{
  background:#fff;
  border-radius:var(--radius);
  box-shadow:0 10px 30px rgba(10,42,94,.1);
  border:1px solid #e7edf7;
  overflow:hidden;
}
.vtop{
  padding:12px 14px;
  border-bottom:1px solid #eef1f6;
  display:flex;align-items:center;justify-content:space-between;
}
.videoBox{
  background:#0b0f1a;
  aspect-ratio:16/10;
  position:relative;
}
video{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;
  background:#0b0f1a;
}

.controls{
  background:#fff;
  border-radius:var(--radius);
  border:1px solid #e7edf7;
  box-shadow:0 10px 30px rgba(10,42,94,.1);
  padding:14px;
  display:grid;gap:12px;
}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
.status{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
.dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
.dot.ok{background:#2ecc71}

.btns{display:flex;flex-wrap:wrap;gap:10px}
button{
  border:none;border-radius:14px;
  padding:12px 14px;
  font-weight:900;
  min-width:140px;
  cursor:pointer;
}
.primary{background:var(--success);color:#fff}
.blue{background:var(--primary);color:#fff}
.red{background:var(--danger);color:#fff}
.ghost{background:#eef3fb;color:var(--primary)}

small.help{color:var(--muted);line-height:1.5}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="back" id="backBtn">‚Üê</div>
  <div class="headMeta">
    <strong>Consultation s√©curis√©e</strong>
    <span id="subLine">Initialisation‚Ä¶</span>
  </div>
</header>

<main>

<section class="vgrid">
  <div class="vcard">
    <div class="vtop"><b>Votre cam√©ra</b><span id="meRole">‚Äî</span></div>
    <div class="videoBox">
      <video id="localVideo" playsinline muted autoplay></video>
    </div>
  </div>

  <div class="vcard">
    <div class="vtop"><b>Interlocuteur</b><span id="peerRole">‚Äî</span></div>
    <div class="videoBox">
      <video id="remoteVideo" playsinline autoplay></video>
    </div>
  </div>
</section>

<section class="controls">
  <div class="row">
    <div class="status">
      <span class="dot" id="connDot"></span>
      <span id="connText">V√©rification‚Ä¶</span>
    </div>

    <div class="btns">
      <button class="ghost" id="unlockBtn">üîä Activer le son</button>
      <button class="primary" id="startBtn">üìû D√©marrer</button>
      <button class="blue" id="muteBtn">üéôÔ∏è Muet</button>
      <button class="red" id="hangBtn">‚õî Quitter</button>
    </div>
  </div>

  <small class="help">
    Astuce : pour des raisons de s√©curit√© navigateur, l‚Äôaudio doit √™tre activ√© par un clic.
  </small>
</section>

</main>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* DOM */
const backBtn = document.getElementById("backBtn");
const unlockBtn = document.getElementById("unlockBtn");
const startBtn = document.getElementById("startBtn");
const muteBtn = document.getElementById("muteBtn");
const hangBtn = document.getElementById("hangBtn");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const connDot = document.getElementById("connDot");
const connText = document.getElementById("connText");
const subLine = document.getElementById("subLine");
const meRole = document.getElementById("meRole");
const peerRole = document.getElementById("peerRole");

backBtn.onclick = ()=>history.back();
const params=new URLSearchParams(location.search);
const requestId=params.get("requestId");

let pc=null, localStream=null, audioUnlocked=false, isMuted=false;
let reqData=null, role=null;
const callRef=doc(db,"callSessions",requestId);

/* ===== AUDIO UNLOCK (FIX) ===== */
unlockBtn.onclick=async()=>{
  audioUnlocked=true;
  unlockBtn.textContent="üîä Son activ√©";
  unlockBtn.disabled=true;
  setStatus(true,"Audio pr√™t");
};

/* ===== STATUS ===== */
function setStatus(ok,text){
  connDot.classList.toggle("ok",!!ok);
  connText.textContent=text;
}

/* ===== MEDIA ===== */
async function startMedia(){
  if(localStream) return;
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;
}

/* ===== PC ===== */
function createPC(){
  pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

  pc.ontrack=async e=>{
    remoteVideo.srcObject=e.streams[0];
    if(audioUnlocked){
      try{
        remoteVideo.muted=false;
        await remoteVideo.play();
      }catch{}
    }
  };

  pc.onicecandidate=e=>{
    if(e.candidate){
      updateDoc(callRef,{ice:JSON.stringify(e.candidate)});
    }
  };
}

/* ===== SECURITY ===== */
async function authorize(user){
  const snap=await getDoc(doc(db,"requests",requestId));
  if(!snap.exists()) return false;
  reqData=snap.data();
  if(user.uid!==reqData.patientUid && user.uid!==reqData.assignedProUid) return false;

  role=user.uid===reqData.assignedProUid?"pro":"patient";
  meRole.textContent=role==="pro"?"Professionnel":"Patient";
  peerRole.textContent=role==="pro"?"Patient":"Professionnel";
  subLine.textContent=role==="patient"
    ?`Avec Dr ${reqData.assignedProName}`
    :`Avec ${reqData.fullName}`;

  return true;
}

/* ===== CALL FLOW ===== */
startBtn.onclick=async()=>{
  try{
    await setDoc(callRef,{requestId,status:"calling"}, {merge:true});
    createPC();
    await startMedia();
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    await updateDoc(callRef,{offer:JSON.stringify(offer)});
    setStatus(true,"Appel lanc√©");
  }catch{
    alert("Erreur d√©marrage appel");
  }
};

muteBtn.onclick=()=>{
  if(!localStream) return;
  isMuted=!isMuted;
  localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
  muteBtn.textContent=isMuted?"üîá Muet (ON)":"üéôÔ∏è Muet";
};

hangBtn.onclick=async()=>{
  if(pc) pc.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  await updateDoc(callRef,{status:"ended",endedAt:serverTimestamp()});
  history.back();
};

/* ===== INIT ===== */
onAuthStateChanged(auth,async user=>{
  if(!user) return location.href="/cizahealth/index.html";
  if(!await authorize(user)) return alert("Acc√®s refus√©");

  setStatus(true,"Pr√™t");
  await setDoc(callRef,{requestId},{merge:true});

  onSnapshot(callRef,async snap=>{
    const d=snap.data();
    if(d.offer && !pc){
      createPC();
      await startMedia();
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      await pc.setRemoteDescription(JSON.parse(d.offer));
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await updateDoc(callRef,{answer:JSON.stringify(answer)});
      setStatus(true,"Connect√©");
    }
    if(d.answer && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(d.answer));
    }
    if(d.ice && pc){
      try{await pc.addIceCandidate(JSON.parse(d.ice))}catch{}
    }
  });
});
</script>

</div>
</body>
</html>
