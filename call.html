<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, setDoc, updateDoc,
  onSnapshot, serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const hangupBtn = document.getElementById("hangupBtn");

const rtcConfig = {
  iceServers:[{ urls:"stun:stun.l.google.com:19302" }]
};

let pc = null;
let localStream = null;
let role = null;
let callRef = null;

onAuthStateChanged(auth, async(user)=>{
  if(!user || !requestId){
    alert("AccÃ¨s refusÃ©");
    return location.href="/cizahealth/index.html";
  }

  /* LOAD REQUEST */
  const reqRef = doc(db,"requests",requestId);
  const reqSnap = await getDoc(reqRef);
  if(!reqSnap.exists()){
    alert("Demande introuvable");
    return;
  }

  const req = reqSnap.data();

  if(user.uid === req.patientUid) role="patient";
  if(user.uid === req.assignedProUid) role="pro";

  if(!role){
    alert("Non autorisÃ© Ã  participer Ã  lâ€™appel");
    return;
  }

  callRef = doc(db,"callSessions",requestId);

  /* INIT WEBRTC */
  pc = new RTCPeerConnection(rtcConfig);

  localStream = await navigator.mediaDevices.getUserMedia({
    audio:true,
    video:true
  });

  localVideo.srcObject = localStream;
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack = e=>{
    remoteVideo.srcObject = e.streams[0];
  };

  pc.onicecandidate = e=>{
    if(e.candidate){
      updateDoc(callRef,{
        iceCandidate: JSON.stringify(e.candidate)
      });
    }
  };

  /* ðŸ‘‰ SEUL LE PRO CRÃ‰E / DÃ‰MARRE Lâ€™APPEL */
  if(role === "pro"){
    await setDoc(callRef,{
      requestId,
      patientUid: req.patientUid,
      assignedProUid: req.assignedProUid,
      status: "calling",
      startedAt: serverTimestamp()
    },{merge:true});

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await updateDoc(callRef,{
      offer: JSON.stringify(offer)
    });
  }

  /* SIGNALING â€” PATIENT Ã‰COUTE */
  onSnapshot(callRef, async(snap)=>{
    if(!snap.exists()) return;
    const data = snap.data();

    // PATIENT reÃ§oit lâ€™appel
    if(role==="patient" && data.offer && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await updateDoc(callRef,{
        answer: JSON.stringify(answer),
        status: "connected"
      });
    }

    // PRO reÃ§oit la rÃ©ponse
    if(role==="pro" && data.answer && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(data.answer));
    }

    if(data.iceCandidate){
      try{
        await pc.addIceCandidate(JSON.parse(data.iceCandidate));
      }catch(e){}
    }

    if(data.status==="ended"){
      cleanup();
      history.back();
    }
  });

  hangupBtn.onclick = async()=>{
    await updateDoc(callRef,{
      status:"ended",
      endedAt:serverTimestamp()
    });
    cleanup();
    history.back();
  };
});

function cleanup(){
  if(pc){ pc.close(); pc=null; }
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
  }
}
</script>
