<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>CizaHealth+ | Appel sÃ©curisÃ©</title>

<style>
:root{
  --primary:#123c8a;
  --primary-dark:#0b2c66;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --success:#1b6b3a;
  --danger:#c0392b;
  --warning:#e67e22;
  --radius:22px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;
}

/* ===== Shell ===== */
.app{
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* ===== Header ===== */
header{
  position:sticky;
  top:0;
  z-index:10;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  padding:14px 16px;
}
.header-inner{
  max-width:1100px;
  margin:0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.h-left{min-width:0}
.h-title{
  font-weight:900;
  font-size:15px;
  line-height:1.2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.h-sub{
  font-size:12px;
  opacity:.92;
  margin-top:3px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.h-chip{
  display:flex;
  align-items:center;
  gap:8px;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.18);
  padding:8px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  flex-shrink:0;
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:#d1d5db;
}
.dot.ok{background:#2ecc71}
.dot.warn{background:#f59e0b}
.dot.err{background:#ef4444}

/* ===== Content ===== */
.main{
  flex:1;
  display:flex;
  align-items:stretch;
  justify-content:center;
  padding:14px;
}
.stage{
  width:100%;
  max-width:1100px;
  display:grid;
  gap:14px;
  grid-template-rows: 1fr auto;
}

/* ===== Video area ===== */
.video-grid{
  display:grid;
  gap:14px;
  grid-template-columns: 1fr;
}

.video-card{
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:0 12px 34px rgba(10,42,94,.10);
  border:1px solid #e9eef8;
  position:relative;
  min-height:220px;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
  background:#0b1220;
  display:block;
}

.label{
  position:absolute;
  top:12px;left:12px;
  background:rgba(0,0,0,.45);
  color:#fff;
  padding:7px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  backdrop-filter: blur(8px);
}

.pip{
  position:absolute;
  right:12px;
  bottom:12px;
  width:min(38%, 220px);
  aspect-ratio: 4/3;
  border-radius:16px;
  overflow:hidden;
  border:2px solid rgba(255,255,255,.18);
  box-shadow:0 14px 40px rgba(0,0,0,.25);
}

/* ===== Controls ===== */
.controls{
  background:var(--card);
  border-radius:var(--radius);
  border:1px solid #e9eef8;
  box-shadow:0 12px 34px rgba(10,42,94,.10);
  padding:12px;
  display:flex;
  gap:10px;
  justify-content:space-between;
  align-items:center;
}

.btn{
  border:none;
  border-radius:16px;
  padding:14px 14px;
  font-weight:900;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  min-height:48px;
  flex:1;
  user-select:none;
}
.btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
.btn.gray{background:#eef3fb;color:#0b2c66}
.btn.danger{background:linear-gradient(135deg,#c0392b,#8a1f1f);color:#fff}
.btn:disabled{opacity:.55;cursor:not-allowed}

.small{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:10px;
}

/* ===== Overlays ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(10,20,40,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:99;
}
.modal{
  width:min(560px, 100%);
  background:#fff;
  border-radius:24px;
  padding:18px 18px 16px;
  box-shadow:0 22px 70px rgba(0,0,0,.35);
  border:1px solid #e9eef8;
}
.modal h2{
  margin:0 0 8px;
  font-size:16px;
}
.modal p{
  margin:0;
  font-size:13.5px;
  color:var(--muted);
  line-height:1.55;
}
.modal .row{
  display:flex;
  gap:10px;
  margin-top:14px;
}
.modal .row .btn{min-height:46px}

#audioUnlock{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(18px + env(safe-area-inset-bottom));
  z-index:50;
  display:none;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  border:none;
  border-radius:999px;
  padding:14px 18px;
  font-weight:900;
  box-shadow:0 18px 50px rgba(10,42,94,.35);
}

@media (min-width: 900px){
  .video-grid{grid-template-columns: 1fr}
  .video-card{min-height:420px}
}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="header-inner">
    <div class="h-left">
      <div class="h-title" id="hdrTitle">Consultation sÃ©curisÃ©e</div>
      <div class="h-sub" id="hdrSub">Connexionâ€¦</div>
    </div>
    <div class="h-chip">
      <span class="dot warn" id="hdrDot"></span>
      <span id="hdrState">VÃ©rification</span>
    </div>
  </div>
</header>

<div class="main">
  <div class="stage">

    <div class="video-grid">
      <div class="video-card">
        <div class="label" id="remoteLabel">VidÃ©o distant</div>
        <video id="remoteVideo" autoplay playsinline></video>

        <div class="pip">
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
      </div>
    </div>

    <div>
      <div class="controls">
        <button class="btn primary" id="startBtn">ðŸ“ž DÃ©marrer</button>
        <button class="btn gray" id="muteBtn" disabled>ðŸŽ¤ Muet</button>
        <button class="btn gray" id="camBtn" disabled>ðŸ“· CamÃ©ra</button>
        <button class="btn danger" id="endBtn" disabled>â›” Quitter</button>
      </div>
      <div class="small" id="hint">
        Astuce : si tu nâ€™entends rien, clique <b>Activer le son</b> (rÃ¨gle iPhone / navigateur).
      </div>
    </div>

  </div>
</div>

<button id="audioUnlock">ðŸ”Š Activer le son</button>

<!-- Overlay erreur -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h2 id="ovTitle">AccÃ¨s refusÃ©</h2>
    <p id="ovMsg">Vous nâ€™Ãªtes pas autorisÃ© Ã  accÃ©der Ã  cet appel.</p>
    <div class="row">
      <button class="btn gray" id="ovBack">Retour</button>
      <button class="btn primary" id="ovOk">OK</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, setDoc, updateDoc, onSnapshot,
  collection, addDoc, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== DOM ===== */
const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");

const hdrTitle = document.getElementById("hdrTitle");
const hdrSub   = document.getElementById("hdrSub");
const hdrDot   = document.getElementById("hdrDot");
const hdrState = document.getElementById("hdrState");

const localVideo  = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

const startBtn = document.getElementById("startBtn");
const muteBtn  = document.getElementById("muteBtn");
const camBtn   = document.getElementById("camBtn");
const endBtn   = document.getElementById("endBtn");

const audioUnlock = document.getElementById("audioUnlock");

const overlay = document.getElementById("overlay");
const ovTitle = document.getElementById("ovTitle");
const ovMsg   = document.getElementById("ovMsg");
document.getElementById("ovOk").onclick = ()=> overlay.style.display="none";
document.getElementById("ovBack").onclick = ()=> history.back();

function setState(type, text){
  hdrDot.classList.remove("ok","warn","err");
  if(type==="ok") hdrDot.classList.add("ok");
  if(type==="warn") hdrDot.classList.add("warn");
  if(type==="err") hdrDot.classList.add("err");
  hdrState.textContent = text;
}

function showError(title, msg){
  ovTitle.textContent = title;
  ovMsg.textContent = msg;
  overlay.style.display="flex";
  setState("err","BloquÃ©");
}

/* ===== Guard: requestId ===== */
if(!requestId){
  showError("Lien invalide", "Il manque requestId dans lâ€™URL. Ouvre lâ€™appel depuis le bouton ðŸ“ž de la consultation.");
}

/* ===== WebRTC ===== */
const rtcConfig = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] };

let pc = null;
let localStream = null;

let me = null;
let role = null; // "patient" | "pro"
let reqData = null;

let callRef = null;
let offerCandidatesRef = null;
let answerCandidatesRef = null;

/* ===== Buttons ===== */
muteBtn.onclick = ()=>{
  if(!localStream) return;
  const track = localStream.getAudioTracks()[0];
  if(!track) return;
  track.enabled = !track.enabled;
  muteBtn.textContent = track.enabled ? "ðŸŽ¤ Muet" : "ðŸ”‡ RÃ©activer";
};

camBtn.onclick = ()=>{
  if(!localStream) return;
  const track = localStream.getVideoTracks()[0];
  if(!track) return;
  track.enabled = !track.enabled;
  camBtn.textContent = track.enabled ? "ðŸ“· CamÃ©ra" : "ðŸš« CamÃ©ra";
};

audioUnlock.onclick = async ()=>{
  try{
    remoteVideo.muted = false;
    await remoteVideo.play();
    audioUnlock.style.display = "none";
  }catch(e){
    // si encore bloquÃ©, lâ€™utilisateur reclique
  }
};

endBtn.onclick = async ()=>{
  try{
    if(localStream) localStream.getTracks().forEach(t=>t.stop());
    if(pc) pc.close();
  }catch{}
  pc = null;
  localStream = null;

  // on laisse le doc callSessions, mais on peut marquer ended
  try{
    if(callRef) await updateDoc(callRef,{status:"ended",endedAt:serverTimestamp()});
  }catch{}

  history.back();
};

/* ===== Core ===== */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    showError("Connexion requise", "Veuillez vous connecter pour accÃ©der Ã  lâ€™appel.");
    return;
  }
  me = user;

  setState("warn","VÃ©rification");
  hdrSub.textContent = "Validation de la consultationâ€¦";

  // 1) charger request
  const reqRef = doc(db,"requests",requestId);
  const reqSnap = await getDoc(reqRef);
  if(!reqSnap.exists()){
    showError("Consultation introuvable", "Cette demande nâ€™existe pas ou a Ã©tÃ© supprimÃ©e.");
    return;
  }
  reqData = reqSnap.data();

  // 2) vÃ©rifier statut + champs (IMPORTANT : ton schÃ©ma)
  const patientUid = reqData.patientUid;
  const proUid = reqData.assignedProUid;
  const status = reqData.status;

  if(status !== "assigned"){
    showError("Appel indisponible", "Lâ€™appel est possible uniquement aprÃ¨s acceptation du professionnel.");
    return;
  }

  // 3) autorisation
  if(me.uid === patientUid) role = "patient";
  else if(me.uid === proUid) role = "pro";
  else{
    showError("AccÃ¨s refusÃ©", "Vous nâ€™Ãªtes ni le patient ni le professionnel assignÃ©.");
    return;
  }

  hdrTitle.textContent = "Consultation sÃ©curisÃ©e";
  hdrSub.textContent = role === "patient"
    ? `Avec Dr ${reqData.assignedProName || "le professionnel"}`
    : "Avec le patient";
  setState("ok","AutorisÃ©");

  // 4) init callSession
  callRef = doc(db,"callSessions",requestId);
  offerCandidatesRef = collection(db,"callSessions",requestId,"offerCandidates");
  answerCandidatesRef = collection(db,"callSessions",requestId,"answerCandidates");

  await setDoc(callRef,{
    requestId,
    patientUid,
    proUid,
    status:"ready",
    updatedAt:serverTimestamp()
  },{merge:true});

  // 5) UI enable
  startBtn.textContent = role === "patient" ? "ðŸ“ž DÃ©marrer" : "ðŸ“ž Rejoindre";
  startBtn.disabled = false;
  endBtn.disabled = false;
  muteBtn.disabled = false;
  camBtn.disabled = false;

  // 6) bouton start
  startBtn.onclick = async ()=>{
    startBtn.disabled = true;
    setState("warn","Connexionâ€¦");
    hdrSub.textContent = "Initialisation audio/vidÃ©oâ€¦";

    // local media
    localStream = await navigator.mediaDevices.getUserMedia({
      video:true,
      audio:{
        echoCancellation:true,
        noiseSuppression:true,
        autoGainControl:true
      }
    });
    localVideo.srcObject = localStream;

    pc = new RTCPeerConnection(rtcConfig);

    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

    pc.ontrack = (e)=>{
      remoteVideo.srcObject = e.streams[0];
      // afficher bouton audio unlock (iOS)
      audioUnlock.style.display = "block";
    };

    pc.onicecandidate = async (e)=>{
      if(!e.candidate) return;
      // patient -> offerCandidates, pro -> answerCandidates
      if(role === "patient"){
        await addDoc(offerCandidatesRef, e.candidate.toJSON());
      }else{
        await addDoc(answerCandidatesRef, e.candidate.toJSON());
      }
    };

    // patient crÃ©e lâ€™offre, pro attend lâ€™offre puis rÃ©pond
    if(role === "patient"){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await updateDoc(callRef,{
        offer:{
          type: offer.type,
          sdp: offer.sdp
        },
        status:"calling",
        startedAt:serverTimestamp(),
        updatedAt:serverTimestamp()
      });

      setState("warn","En appelâ€¦");
      hdrSub.textContent = "En attente du professionnelâ€¦";
    }else{
      // PRO: attendre lâ€™offre via snapshot
      setState("warn","Connexionâ€¦");
      hdrSub.textContent = "Connexion Ã  lâ€™appel du patientâ€¦";
    }

    // listen call doc (offer/answer)
    onSnapshot(callRef, async (snap)=>{
      const c = snap.data();
      if(!c) return;

      // PRO reÃ§oit offer -> setRemote -> create answer
      if(role === "pro" && c.offer && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(c.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await updateDoc(callRef,{
          answer:{type:answer.type, sdp:answer.sdp},
          status:"connected",
          updatedAt:serverTimestamp()
        });
        setState("ok","ConnectÃ©");
        hdrSub.textContent = "Appel en cours";
      }

      // PATIENT reÃ§oit answer
      if(role === "patient" && c.answer && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(c.answer);
        setState("ok","ConnectÃ©");
        hdrSub.textContent = "Appel en cours";
      }

      if(c.status === "ended"){
        setState("warn","TerminÃ©");
        hdrSub.textContent = "Lâ€™appel a Ã©tÃ© terminÃ©.";
      }
    });

    // listen candidates
    onSnapshot(role==="patient" ? answerCandidatesRef : offerCandidatesRef, async (snap)=>{
      for(const change of snap.docChanges()){
        if(change.type === "added"){
          try{
            await pc.addIceCandidate(change.doc.data());
          }catch{}
        }
      }
    });
  };

});
</script>

</body>
</html>
