<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CizaHealth+ | Appel Consultation</title>

<style>
:root{
  --primary:#0E3A8A;
  --danger:#C0392B;
  --success:#1B6B3A;
  --bg:#0b1220;
  --radius:22px;
}

*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  height:100%;
  background:var(--bg);
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
}

.app{
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
header{
  padding:14px 18px;
  color:#fff;
  display:flex;
  align-items:center;
  gap:12px;
}
header .back{
  font-size:22px;
  cursor:pointer;
}
header .meta{
  flex:1;
}
header strong{display:block}
header span{font-size:13px;opacity:.85}

/* ===== VIDEO ===== */
.videos{
  flex:1;
  display:grid;
  grid-template-rows:1fr 1fr;
  gap:14px;
  padding:14px;
}

video{
  width:100%;
  height:100%;
  background:#000;
  border-radius:var(--radius);
  object-fit:cover;
}

/* ===== CONTROLS ===== */
.controls{
  padding:16px;
  display:flex;
  gap:12px;
}

.controls button{
  flex:1;
  border:none;
  border-radius:16px;
  padding:14px;
  font-size:15px;
  font-weight:800;
  color:#fff;
  cursor:pointer;
}

.start{background:var(--success)}
.mute{background:#34495e}
.end{background:var(--danger)}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="back" onclick="history.back()">‚Üê</div>
  <div class="meta">
    <strong id="callTitle">Appel en cours</strong>
    <span id="callSub">Connexion‚Ä¶</span>
  </div>
</header>

<div class="videos">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<div class="controls">
  <button class="start" id="startBtn">üìû D√©marrer</button>
  <button class="mute" id="muteBtn">üé§ Muet</button>
  <button class="end" id="hangupBtn">‚õî Quitter</button>
</div>

</div>

<!-- =========================
LOGIQUE WEBRTC + FIRESTORE
========================= -->
<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =========================
PARAMS
========================= */
const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const startBtn = document.getElementById("startBtn");
const muteBtn = document.getElementById("muteBtn");
const hangupBtn = document.getElementById("hangupBtn");
const callSub = document.getElementById("callSub");

/* =========================
WEBRTC
========================= */
const rtcConfig = {
  iceServers:[{urls:"stun:stun.l.google.com:19302"}]
};

let pc = null;
let localStream = null;
let muted = false;

/* =========================
AUTH + AUTORISATION
========================= */
onAuthStateChanged(auth, async(user)=>{
  if(!user || !requestId){
    alert("Acc√®s refus√©");
    return history.back();
  }

  const reqRef = doc(db,"requests",requestId);
  const reqSnap = await getDoc(reqRef);

  if(!reqSnap.exists()){
    alert("Demande introuvable");
    return history.back();
  }

  const req = reqSnap.data();

  // ‚úÖ AUTORISATION STRICTE
  if(
    user.uid !== req.patientUid &&
    user.uid !== req.assignedProUid
  ){
    alert("Non autoris√© √† faire cet appel");
    return history.back();
  }

  callSub.textContent =
    user.uid === req.assignedProUid
      ? "Appel avec le patient"
      : `Appel avec Dr ${req.assignedProName || ""}`;

  const callRef = doc(db,"callSessions",requestId);

  await setDoc(callRef,{
    requestId,
    status:"idle",
    createdAt:serverTimestamp()
  },{merge:true});

  /* =========================
  START CALL
  ========================= */
  startBtn.onclick = async ()=>{
    pc = new RTCPeerConnection(rtcConfig);

    localStream = await navigator.mediaDevices.getUserMedia({
      video:true,
      audio:true
    });

    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

    pc.ontrack = e=>{
      remoteVideo.srcObject = e.streams[0];
    };

    pc.onicecandidate = e=>{
      if(e.candidate){
        updateDoc(callRef,{
          iceCandidate:JSON.stringify(e.candidate)
        });
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await updateDoc(callRef,{
      offer:JSON.stringify(offer),
      status:"calling"
    });
  };

  /* =========================
  SIGNALING
  ========================= */
  onSnapshot(callRef, async(snap)=>{
    if(!snap.exists()) return;
    const d = snap.data();

    if(d.offer && !pc){
      pc = new RTCPeerConnection(rtcConfig);

      localStream = await navigator.mediaDevices.getUserMedia({
        video:true,
        audio:true
      });

      localVideo.srcObject = localStream;
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

      pc.ontrack = e=>{
        remoteVideo.srcObject = e.streams[0];
      };

      await pc.setRemoteDescription(JSON.parse(d.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await updateDoc(callRef,{
        answer:JSON.stringify(answer),
        status:"connected"
      });
    }

    if(d.answer && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(d.answer));
    }

    if(d.iceCandidate && pc){
      try{
        await pc.addIceCandidate(JSON.parse(d.iceCandidate));
      }catch{}
    }
  });

});

/* =========================
MUTE
========================= */
muteBtn.onclick=()=>{
  if(!localStream) return;
  muted=!muted;
  localStream.getAudioTracks().forEach(t=>t.enabled=!muted);
  muteBtn.textContent = muted ? "üîá Muet" : "üé§ Muet";
};

/* =========================
HANGUP
========================= */
hangupBtn.onclick=async()=>{
  if(pc) pc.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  history.back();
};
</script>

</body>
</html>
