<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Appel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:#f4f7fb;
}
.app{
  max-width:700px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:#fff;
}
header{
  padding:16px;
  background:#123c8a;
  color:#fff;
  font-weight:700;
}
.center{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:16px;
  text-align:center;
}
.status{
  font-size:18px;
  font-weight:700;
}
.actions{
  display:flex;
  gap:12px;
}
button{
  padding:14px 22px;
  border:none;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
}
.accept{background:#1b6b3a;color:#fff}
.end{background:#c0392b;color:#fff}
.hidden{display:none}
</style>
</head>

<body>
<div class="app">

<header>
  ðŸ“ž Appel en cours
</header>

<div class="center">
  <div id="callStatus" class="status">Connexionâ€¦</div>

  <div class="actions">
    <button id="acceptBtn" class="accept hidden">Accepter</button>
    <button id="endBtn" class="end hidden">Raccrocher</button>
  </div>
</div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, setDoc, updateDoc, onSnapshot, serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");
const role = params.get("role"); // "pro" | "patient"

if(!requestId || !role){
  alert("Appel invalide");
  throw new Error("Missing params");
}

const callRef = doc(db,"callSessions",requestId);

const callStatus = document.getElementById("callStatus");
const acceptBtn = document.getElementById("acceptBtn");
const endBtn = document.getElementById("endBtn");

onAuthStateChanged(auth,user=>{
  if(!user) return location.href="/cizahealth/index.html";

  /* ðŸ”´ INIT SESSION (merge = safe) */
  setDoc(callRef,{
    requestId,
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp(),
    status: "ringing",
    proUid: role==="pro" ? user.uid : null,
    patientUid: role==="patient" ? user.uid : null
  },{ merge:true });

  /* ðŸ‘‚ LISTEN STATUS */
  onSnapshot(callRef,snap=>{
    if(!snap.exists()) return;
    const c = snap.data();

    if(c.status==="ringing"){
      callStatus.textContent = role==="patient"
        ? "ðŸ“ž Appel entrant"
        : "ðŸ“ž Appel en coursâ€¦";
      acceptBtn.classList.toggle("hidden", role!=="patient");
      endBtn.classList.remove("hidden");
    }

    if(c.status==="accepted"){
      callStatus.textContent = "ðŸŸ¢ Appel connectÃ©";
      acceptBtn.classList.add("hidden");
      endBtn.classList.remove("hidden");
    }

    if(c.status==="ended"){
      callStatus.textContent = "ðŸ”´ Appel terminÃ©";
      acceptBtn.classList.add("hidden");
      endBtn.classList.add("hidden");
    }
  });

  /* âœ… ACCEPT (patient) */
  acceptBtn.onclick=async()=>{
    await updateDoc(callRef,{
      status:"accepted",
      patientUid:user.uid,
      updatedAt:serverTimestamp()
    });
  };

  /* âŒ END (both) */
  endBtn.onclick=async()=>{
    await updateDoc(callRef,{
      status:"ended",
      updatedAt:serverTimestamp()
    });
  };
});
</script>

</body>
</html>
