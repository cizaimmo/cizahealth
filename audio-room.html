<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Consultation audio s√©curis√©e</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#123c8a;
  --bg:#f4f7fb;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:20px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:600px;
  margin:auto;
  min-height:100vh;
  background:#fff;
  display:flex;
  flex-direction:column;
}
.header{
  padding:16px;
  border-bottom:1px solid #eef1f6;
  text-align:center;
  font-weight:600;
}
.content{
  padding:20px;
  flex:1;
}
.card{
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(10,42,94,.08);
  margin-bottom:16px;
}
.status{
  font-size:14px;
  color:var(--muted);
  margin-bottom:10px;
}
.chat{
  border:1px solid #e5eaf3;
  border-radius:14px;
  padding:12px;
  height:200px;
  overflow-y:auto;
  font-size:14px;
}
.msg{
  margin-bottom:8px;
}
.msg strong{color:var(--blue)}
.input-row{
  display:flex;
  gap:8px;
  margin-top:10px;
}
input{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:1px solid #dfe5f0;
}
button{
  padding:14px;
  border:none;
  border-radius:16px;
  background:linear-gradient(135deg,#123c8a,#1b4fa3);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button.danger{
  background:#c0392b;
}
.footer{
  padding:14px;
  border-top:1px solid #eef1f6;
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    Consultation audio s√©curis√©e
  </div>

  <div class="content">

    <div class="card">
      <div class="status" id="callStatus">Connexion en cours‚Ä¶</div>
      <audio id="remoteAudio" autoplay></audio>
      <button class="danger" onclick="endCall()">Terminer l‚Äôappel</button>
    </div>

    <div class="card">
      <div class="status">Chat s√©curis√©</div>
      <div class="chat" id="chatBox"></div>
      <div class="input-row">
        <input id="chatInput" placeholder="√âcrire un message‚Ä¶">
        <button onclick="sendMessage()">Envoyer</button>
      </div>
    </div>

  </div>

  <div class="footer">
    CizaHealth+ ‚Äî Appel non enregistr√©
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üîß CONFIG FIREBASE (utilise TON firebase.js si tu veux) */
const firebaseConfig = {
 apiKey: "AIzaSyBR7qDT3a56XqCBu-XeZB6IDR9po9CQX-w",
  authDomain: "cizahealth.firebaseapp.com",
  projectId: "cizahealth", 
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üîë PARAM√àTRES URL */
const params = new URLSearchParams(window.location.search);
const requestId = params.get("request") || "TEST123";
const role = params.get("role") || "patient";

/* üîä WEBRTC */
const pc = new RTCPeerConnection();
const roomRef = doc(db,"audioRooms",requestId);

navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
  stream.getTracks().forEach(track=>pc.addTrack(track,stream));
});

pc.ontrack = e=>{
  document.getElementById("remoteAudio").srcObject = e.streams[0];
};

pc.onicecandidate = e=>{
  if(e.candidate){
    updateDoc(roomRef,{
      ice: arrayUnion(JSON.stringify(e.candidate))
    });
  }
};

async function init(){
  const snap = await getDoc(roomRef);

  if(!snap.exists()){
    await setDoc(roomRef,{});
  }

  if(role === "patient"){
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await updateDoc(roomRef,{offer});
    callStatus.innerText="En attente du professionnel‚Ä¶";
  }

  onSnapshot(roomRef, async s=>{
    const d = s.data();

    if(d.offer && role==="pro" && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(d.offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await updateDoc(roomRef,{answer});
      callStatus.innerText="Appel connect√©";
    }

    if(d.answer && role==="patient" && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(d.answer);
      callStatus.innerText="Appel connect√©";
    }

    if(d.ice){
      d.ice.forEach(c=>{
        pc.addIceCandidate(JSON.parse(c));
      });
    }

    if(d.chat){
      chatBox.innerHTML="";
      d.chat.forEach(m=>{
        const div=document.createElement("div");
        div.className="msg";
        div.innerHTML=`<strong>${m.role}:</strong> ${m.text}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    if(d.ended){
      callStatus.innerText="Appel termin√©";
      pc.close();
    }
  });
}

init();

/* üí¨ CHAT */
function sendMessage(){
  const text = chatInput.value.trim();
  if(!text) return;
  updateDoc(roomRef,{
    chat: arrayUnion({role,text,at:Date.now()})
  });
  chatInput.value="";
}

/* üîö FIN APPEL */
function endCall(){
  updateDoc(roomRef,{ended:true});
}
</script>

</body>
</html>
