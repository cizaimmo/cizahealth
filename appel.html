<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Appel sÃ©curisÃ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#000;
  color:#fff;
}
.app{
  height:100vh;
  display:flex;
  flex-direction:column;
}
.header{
  padding:14px;
  text-align:center;
  font-size:14px;
  background:#0a2a5e;
}
.videos{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  position:relative;
}
video{
  background:#000;
  width:100%;
  height:100%;
  object-fit:cover;
}
#local{
  position:absolute;
  width:120px;
  height:160px;
  bottom:16px;
  right:16px;
  border-radius:12px;
  border:2px solid #fff;
}
.controls{
  padding:16px;
  display:flex;
  justify-content:center;
  gap:20px;
  background:#111;
}
.controls button{
  padding:14px 18px;
  border:none;
  border-radius:50%;
  font-size:18px;
  color:#fff;
}
.end{background:#c0392b}
.mute{background:#444}
.video{background:#0a2a5e}
</style>

<script>
let localStream;

function securityCheck(){
  const request = JSON.parse(localStorage.getItem("cizaRequest"));
  const session = JSON.parse(localStorage.getItem("cizaSession"));
  const payment = localStorage.getItem("paymentStatus");
  const callStatus = localStorage.getItem("callStatus");

  if(!request || !session){
    alert("Session invalide");
    window.location.href = "index.html";
    return false;
  }

  if(payment !== "paid"){
    alert("Paiement requis");
    window.location.href = "paiement.html";
    return false;
  }

  if(callStatus !== "accepted"){
    alert("En attente de confirmation du professionnel");
    window.location.href = "matching.html";
    return false;
  }

  return true;
}

async function startCall(){
  if(!securityCheck()) return;

  try{
    localStream = await navigator.mediaDevices.getUserMedia({
      audio:true,
      video:true
    });

    document.getElementById("local").srcObject = localStream;
    document.getElementById("remote").srcObject = localStream;

  }catch(e){
    alert("AccÃ¨s camÃ©ra/micro refusÃ©");
  }
}

function endCall(){
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
  }
  localStorage.removeItem("callStatus");
  alert("Appel terminÃ©");
  window.location.href = "index.html";
}

function toggleMute(){
  localStream.getAudioTracks()[0].enabled =
    !localStream.getAudioTracks()[0].enabled;
}

function toggleVideo(){
  localStream.getVideoTracks()[0].enabled =
    !localStream.getVideoTracks()[0].enabled;
}

document.addEventListener("DOMContentLoaded", startCall);
</script>
</head>

<body>

<div class="app">

  <div class="header">
    ðŸ”’ Appel chiffrÃ© â€” CizaHealth+
  </div>

  <div class="videos">
    <video id="remote" autoplay playsinline></video>
    <video id="local" autoplay muted playsinline></video>
  </div>

  <div class="controls">
    <button class="mute" onclick="toggleMute()">ðŸŽ¤</button>
    <button class="video" onclick="toggleVideo()">ðŸŽ¥</button>
    <button class="end" onclick="endCall()">â›”</button>
  </div>

</div>

</body>
</html>
