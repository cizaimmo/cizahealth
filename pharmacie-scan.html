<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Validation ordonnance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#f4f7fb;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.box{
  background:white;
  padding:30px;
  border-radius:20px;
  box-shadow:0 15px 40px rgba(0,0,0,.1);
  max-width:400px;
  width:100%;
}
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #ddd;
}
button{
  margin-top:15px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#123c8a;
  color:white;
  font-weight:600;
}
.status{
  margin-top:20px;
  padding:12px;
  border-radius:12px;
  text-align:center;
}
.ok{background:#e9f7ef;color:#1b6b3a}
.err{background:#fdecea;color:#8a1f1f}
</style>
</head>

<body>
<div class="box">
<h3>Validation ordonnance</h3>

<input id="codeInput" placeholder="Entrer le code RX">
<button id="validateBtn">Valider</button>

<div id="result"></div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  collection, query, where, getDocs,
  doc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const result = document.getElementById("result");

document.getElementById("validateBtn").onclick = async()=>{

  const code = document.getElementById("codeInput").value.trim();
  if(!code){
    alert("Entrer un code");
    return;
  }

  const q = query(
    collection(db,"prescriptions"),
    where("code","==",code)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    result.innerHTML=`<div class="status err">Code invalide</div>`;
    return;
  }

  const docSnap = snap.docs[0];
  const data = docSnap.data();

  if(data.used){
    result.innerHTML=`<div class="status err">Ordonnance déjà utilisée</div>`;
    return;
  }

  await updateDoc(doc(db,"prescriptions",docSnap.id),{
    used:true,
    usedAt: serverTimestamp(),
    status:"used"
  });

  result.innerHTML=`<div class="status ok">Ordonnance validée avec succès</div>`;
};
</script>

</body>
</html>
