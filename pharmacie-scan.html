<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Scan ordonnance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#f4f7fb;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.container{
  background:white;
  padding:25px;
  border-radius:20px;
  box-shadow:0 20px 50px rgba(0,0,0,.1);
  width:100%;
  max-width:450px;
}
h3{text-align:center;margin-bottom:15px}
#reader{
  width:100%;
  border-radius:16px;
  overflow:hidden;
}
.status{
  margin-top:15px;
  padding:14px;
  border-radius:14px;
  text-align:center;
  font-weight:600;
}
.ok{background:#e9f7ef;color:#1b6b3a}
.err{background:#fdecea;color:#8a1f1f}
</style>
</head>

<body>

<div class="container">
<h3>Scanner ordonnance</h3>
<div id="reader"></div>
<div id="result"></div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script type="module">
import { db } from "./firebase.js";
import {
  collection, query, where, getDocs,
  doc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const result = document.getElementById("result");

function showStatus(type,text){
  result.innerHTML=`<div class="status ${type}">${text}</div>`;
}

async function validateCode(code){

  const q = query(
    collection(db,"prescriptions"),
    where("code","==",code)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    showStatus("err","Ordonnance invalide");
    return;
  }

  const docSnap = snap.docs[0];
  const data = docSnap.data();

  if(data.used){
    showStatus("err","Ordonnance déjà utilisée");
    return;
  }

  await updateDoc(doc(db,"prescriptions",docSnap.id),{
    used:true,
    usedAt: serverTimestamp(),
    status:"used"
  });

  showStatus("ok","Ordonnance validée ✔");
}

const html5QrCode = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(devices=>{
  if(devices && devices.length){
    const cameraId = devices[0].id;

    html5QrCode.start(
      cameraId,
      { fps:10, qrbox:250 },
      async (decodedText)=>{
        html5QrCode.stop();
        validateCode(decodedText);
      }
    );
  }
}).catch(err=>{
  showStatus("err","Accès caméra refusé");
});
</script>

</body>
</html>
