<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Validation ordonnance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<style>
:root{
  --blue:#123c8a;
  --blue-dark:#0b2c66;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:22px;
  --ok:#1b6b3a;
  --err:#8a1f1f;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:linear-gradient(180deg,#f4f7fb,#eef3fa);
  color:var(--text);
}
.app{
  max-width:600px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  padding:18px 22px;
  background:linear-gradient(90deg,var(--blue),var(--blue-dark));
  color:#fff;
}
header strong{font-size:16px;display:block}

.content{padding:22px}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(10,42,94,.08);
  margin-bottom:18px;
}
input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #dde3ef;
  font-size:14px;
  margin-top:8px;
}
button{
  width:100%;
  padding:14px;
  margin-top:16px;
  border:none;
  border-radius:16px;
  background:linear-gradient(135deg,#123c8a,#1b4fa3);
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
.status{
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  font-size:13px;
}
.ok{background:#e9f7f0;color:var(--ok)}
.err{background:#fdecea;color:var(--err)}
.footer{
  margin-top:auto;
  padding:22px;
  text-align:center;
  font-size:12px;
  color:#8a95a8;
}
</style>
</head>

<body>
<div class="app">

<header>
  <strong>Validation ordonnance</strong>
</header>

<div class="content">

  <div class="card">
    <label>Code ordonnance</label>
    <input id="codeInput" placeholder="Ex : RX-AB12CD">
    <button id="validateBtn">Valider l‚Äôordonnance</button>
    <div id="statusBox" class="status" style="display:none"></div>
  </div>

</div>

<div class="footer">
  ¬© 2026 CizaHealth+ ‚Äî CIZA GROUP<br>
  Interface pharmacie s√©curis√©e
</div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, query, where, getDocs,
  updateDoc, doc, getDoc, serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const codeInput = document.getElementById("codeInput");
const validateBtn = document.getElementById("validateBtn");
const statusBox = document.getElementById("statusBox");

function showStatus(type, text){
  statusBox.style.display="block";
  statusBox.className="status "+type;
  statusBox.textContent=text;
}

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="login.html";
    return;
  }

  // üîê V√©rifier r√¥le pharmacie
  const userSnap = await getDoc(doc(db,"users",user.uid));
  if(!userSnap.exists() || userSnap.data().role !== "pharmacie"){
    alert("Acc√®s r√©serv√© aux pharmacies");
    location.href="index.html";
    return;
  }

  validateBtn.onclick = async()=>{
    const code = codeInput.value.trim();
    if(!code){
      showStatus("err","Veuillez entrer un code.");
      return;
    }

    validateBtn.disabled = true;
    validateBtn.textContent = "V√©rification‚Ä¶";

    try{
      const q = query(
        collection(db,"prescriptions"),
        where("code","==",code)
      );

      const snap = await getDocs(q);

      if(snap.empty){
        showStatus("err","Code invalide ou introuvable.");
        validateBtn.disabled=false;
        validateBtn.textContent="Valider l‚Äôordonnance";
        return;
      }

      const docRef = snap.docs[0].ref;
      const data = snap.docs[0].data();

      if(data.used){
        showStatus("err","Cette ordonnance a d√©j√† √©t√© utilis√©e.");
        validateBtn.disabled=false;
        validateBtn.textContent="Valider l‚Äôordonnance";
        return;
      }

      // ‚úÖ Marquer utilis√©e
      await updateDoc(docRef,{
        used:true,
        validatedBy:user.uid,
        validatedAt:serverTimestamp()
      });

      showStatus("ok","Ordonnance valid√©e avec succ√®s.");
      validateBtn.textContent="Valid√©e ‚úî";

    }catch(e){
      showStatus("err","Erreur r√©seau.");
      validateBtn.disabled=false;
      validateBtn.textContent="Valider l‚Äôordonnance";
    }
  };

});
</script>

</body>
</html>
