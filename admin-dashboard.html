<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Administration</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#0a2a5e;
  --bg:#f4f7fb;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:1100px;
  margin:auto;
  min-height:100vh;
  background:#fff;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.header{
  padding:16px 20px;
  border-bottom:1px solid #eef1f6;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
.header-left{
  display:flex;
  align-items:center;
  gap:12px;
}
.header-left img{
  height:40px;
}
.header strong{font-size:16px}
.header button{
  border:none;
  background:none;
  color:#8a1f1f;
  font-weight:600;
  cursor:pointer;
}

/* CONTENT */
.content{
  padding:20px;
}
h2{
  margin:24px 0 12px;
  font-size:18px;
}

/* LIST */
.list{
  display:grid;
  gap:14px;
}
@media(min-width:768px){
  .list{grid-template-columns:1fr 1fr}
}

/* CARD */
.card{
  border:2px solid #e6ebf5;
  border-radius:var(--radius);
  padding:16px;
}
.name{
  font-weight:700;
  font-size:16px;
}
.meta{
  margin-top:4px;
  font-size:13px;
  color:var(--muted);
}
.proid{
  margin-top:8px;
  font-size:13px;
  background:#eef3ff;
  padding:8px 12px;
  border-radius:12px;
  display:inline-block;
}

/* BADGES */
.badge{
  display:inline-block;
  margin-top:8px;
  padding:4px 10px;
  font-size:12px;
  font-weight:600;
  border-radius:999px;
}
.status-pending{background:#fff4cc;color:#8a6d00;}
.status-pending-info{background:#ffe2cc;color:#8a4b00;}
.status-validated{background:#dff5e6;color:#1b6b3a;}
.status-rejected{background:#fde0e0;color:#8a1f1f;}

.service-tele{background:#e6f0ff;color:#0a2a5e;}
.service-home{background:#e9f7f1;color:#1b6b3a;}
.service-pharma{background:#f5ecff;color:#5a3d8a;}

/* ACTIONS */
button.validate{
  margin-top:12px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:12px;
  background:var(--blue);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.admin-actions{
  margin-top:12px;
  display:grid;
  gap:8px;
}
button.info{
  padding:10px;
  border:none;
  border-radius:12px;
  background:#f6a623;
  color:#fff;
  font-weight:600;
}
button.reject{
  padding:10px;
  border:none;
  border-radius:12px;
  background:#b3261e;
  color:#fff;
  font-weight:600;
}
textarea.admin-note{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:13px;
}

/* EMPTY */
.empty{
  text-align:center;
  padding:30px;
  color:var(--muted);
}

/* FOOTER */
.footer{
  margin-top:auto;
  text-align:center;
  padding:16px;
  font-size:12px;
  opacity:.6;
}
</style>
</head>

<body>

<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <img src="https://raw.githubusercontent.com/cizaimmo/cizahealth/c01b9c564d6cf6c89eff8e6bed95ec09d64e002f/9008F813-82B0-4A0C-8B18-00CA519A77CF.png" alt="CizaHealth+">
      <strong>Administration CizaHealth+</strong>
    </div>
    <button id="logoutBtn">Déconnexion</button>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <h2>Professionnels en attente</h2>
    <div id="pendingList" class="list"></div>

    <h2>Professionnels validés</h2>
    <div id="validatedList" class="list"></div>

    <h2>Professionnels refusés</h2>
    <div id="rejectedList" class="list"></div>

  </div>

  <div class="footer">
    © 2026 CizaHealth+ — Administration
  </div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, query, where, getDocs,
  doc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

document.getElementById("logoutBtn").onclick = async ()=>{
  await signOut(auth);
  location.href = "/cizahealth/index.html";
};

onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href="/cizahealth/index.html"; return; }

  const adminCheck = await getDocs(
    query(collection(db,"users"),
    where("__name__","==",user.uid),
    where("role","==","admin"))
  );
  if(adminCheck.empty){ document.body.innerHTML="Accès refusé"; return; }

  const pendingList   = document.getElementById("pendingList");
  const validatedList = document.getElementById("validatedList");
  const rejectedList  = document.getElementById("rejectedList");

  const snap = await getDocs(
    query(collection(db,"users"),
    where("role","in",["doctor","aide","pharmacy_partner"]))
  );

  snap.forEach(d=>{
    const u = d.data();

    const statusClass = {
      pending:"status-pending",
      pending_info:"status-pending-info",
      validated:"status-validated",
      rejected:"status-rejected"
    }[u.status];

    const statusLabel = {
      pending:"EN ATTENTE",
      pending_info:"INFOS MANQUANTES",
      validated:"VALIDÉ",
      rejected:"REFUSÉ"
    }[u.status];

    const serviceClass = {
      doctor:"service-tele",
      aide:"service-home",
      pharmacy_partner:"service-pharma"
    }[u.role];

    const serviceLabel = {
      doctor:"Téléconsultation",
      aide:"Aide à domicile",
      pharmacy_partner:"Pharmacie partenaire"
    }[u.role];

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="name">${u.fullName || "—"}</div>
      <div class="meta">${u.role} • ${u.province || "—"}<br>${u.email || ""}</div>
      <div class="badge ${serviceClass}">${serviceLabel}</div>
      <div class="badge ${statusClass}">${statusLabel}</div>
      ${u.proId ? `<div class="proid">ProID : <b>${u.proId}</b></div>` : ""}
    `;

    if(u.status==="pending" || u.status==="pending_info"){
      const btn=document.createElement("button");
      btn.className="validate";
      btn.textContent="Valider le professionnel";
      btn.onclick=async()=>{
        await updateDoc(doc(db,"users",d.id),{
          status:"validated",
          proId:"PRO-"+Date.now(),
          validatedAt:serverTimestamp(),
          validatedBy:user.uid
        });
        location.reload();
      };

      const note=document.createElement("textarea");
      note.className="admin-note";
      note.placeholder="Message ou motif (obligatoire)";

      const info=document.createElement("button");
      info.className="info";
      info.textContent="Demander des informations";
      info.onclick=async()=>{
        if(!note.value.trim())return;
        await updateDoc(doc(db,"users",d.id),{
          status:"pending_info",
          validationNote:note.value.trim(),
          lastStatusChangeAt:serverTimestamp()
        });
        location.reload();
      };

      const reject=document.createElement("button");
      reject.className="reject";
      reject.textContent="Refuser";
      reject.onclick=async()=>{
        if(!note.value.trim())return;
        await updateDoc(doc(db,"users",d.id),{
          status:"rejected",
          validationNote:note.value.trim(),
          lastStatusChangeAt:serverTimestamp()
        });
        location.reload();
      };

      const actions=document.createElement("div");
      actions.className="admin-actions";
      actions.append(btn,info,reject,note);
      card.appendChild(actions);
      pendingList.appendChild(card);
    }
    else if(u.status==="validated"){
      validatedList.appendChild(card);
    }
    else if(u.status==="rejected"){
      rejectedList.appendChild(card);
    }
  });
});
</script>

</body>
</html>
