<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Administration</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#0a2a5e;
  --bg:#f4f7fb;
  --text:#0a1a2f;
  --muted:#6b7a90;
  --ok:#1b6b3a;
  --warn:#c58a00;
  --err:#8a1f1f;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:1500px;
  margin:auto;
  background:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 20px;
  border-bottom:1px solid #e6ebf5;
}
header .left{
  display:flex;
  align-items:center;
  gap:12px;
}
header img{height:42px}
header strong{font-size:16px}
header button{
  border:none;
  background:none;
  color:var(--err);
  font-weight:600;
  cursor:pointer;
}
.content{padding:20px}
h2{margin:26px 0 10px;font-size:18px}
.list{
  display:grid;
  gap:16px;
}
@media(min-width:900px){
  .list{grid-template-columns:1fr 1fr}
}
.card{
  border:2px solid #e6ebf5;
  border-radius:16px;
  padding:16px;
}
.badge{
  display:inline-block;
  padding:4px 10px;
  font-size:12px;
  font-weight:600;
  border-radius:999px;
  margin-top:6px;
}
.pending{background:#fff4cc;color:#8a6d00}
.validated{background:#dff5e6;color:#1b6b3a}
.rejected{background:#fde0e0;color:#8a1f1f}
.suspended{background:#eee;color:#444}

.section{
  margin-top:10px;
  font-size:13px;
}
.section strong{display:block}
.section.note{
  background:#f9f2f2;
  padding:10px;
  border-radius:10px;
  margin-top:12px;
  color:#8a1f1f;
}

.actions{
  margin-top:14px;
  display:grid;
  gap:8px;
}
.actions button{
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}
.validate{background:var(--blue);color:#fff}
.reject{background:var(--err);color:#fff}
.suspend{background:#555;color:#fff}

.secondary{
  background:#eef3ff;
  color:var(--blue);
  border:1px solid #dbe6ff !important;
}

.pay{
  background:#0b6b3a;
  color:#fff;
}
.notify{
  background:#f6a623;
  color:#fff;
}
.assign{
  background:#5a3d8a;
  color:#fff;
}

textarea{
  width:100%;
  padding:8px;
  border-radius:10px;
  border:1px solid #ddd;
}

footer{
  margin-top:auto;
  text-align:center;
  font-size:12px;
  padding:16px;
  opacity:.65;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(10,26,47,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9999;
}
.modal.open{display:flex}
.modal-box{
  width:min(760px, 100%);
  background:#fff;
  border-radius:18px;
  border:2px solid #e6ebf5;
  padding:16px;
  max-height:85vh;
  overflow:auto;
}
.modal-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding-bottom:10px;
  border-bottom:1px solid #eef1f6;
}
.modal-title{font-weight:800}
.modal-close{
  border:none;
  background:#f4f7fb;
  border-radius:12px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:700;
}
.kv{
  margin-top:12px;
  border:1px solid #e6ebf5;
  border-radius:14px;
  padding:12px;
}
.kv h4{
  margin:0 0 8px;
  font-size:14px;
}
.kv .line{font-size:13px;color:var(--muted);margin-top:4px}
.hr{height:1px;background:#eef1f6;margin:12px 0}

.upload-grid{
  display:grid;
  gap:10px;
}
@media(min-width:720px){
  .upload-grid{grid-template-columns:1fr 1fr}
}
.upload-grid label{font-size:13px;font-weight:700}
.upload-grid input{
  width:100%;
  margin-top:6px;
  padding:10px;
  border-radius:12px;
  border:1.6px solid #e6ebf5;
}
.modal-actions{
  margin-top:10px;
  display:grid;
  gap:8px;
}
@media(min-width:720px){
  .modal-actions{grid-template-columns:1fr 1fr}
}
.modal-actions button{
  padding:12px;
  border:none;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
}
.saveDocs{background:var(--blue);color:#fff}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="left">
    <img src="https://raw.githubusercontent.com/cizaimmo/cizahealth/main/9008F813-82B0-4A0C-8B18-00CA519A77CF.png">
    <strong>Administration CizaHealth+</strong>
  </div>
  <button id="logoutBtn">DÃ©connexion</button>
</header>

<div class="content">

<h2>Professionnels â€” En attente</h2>
<div id="pendingList" class="list"></div>

<h2>Professionnels â€” ValidÃ©s</h2>
<div id="validatedList" class="list"></div>

<h2>Professionnels â€” RefusÃ©s</h2>
<div id="rejectedList" class="list"></div>

</div>

<footer>
Â© 2026 CizaHealth+ â€” CIZA GROUP â€¢ Administration
</footer>

</div>

<!-- MODAL DOSSIER -->
<div id="dossierModal" class="modal">
  <div class="modal-box">
    <div class="modal-head">
      <div class="modal-title" id="modalTitle">Dossier professionnel</div>
      <button class="modal-close" id="closeModalBtn">Fermer</button>
    </div>

    <div id="modalBody"></div>

    <div class="hr"></div>

    <div class="kv">
      <h4>Uploader / Mettre Ã  jour les documents (Admin)</h4>
      <div class="upload-grid">
        <div>
          <label>DiplÃ´me (PDF)</label>
          <input id="adminDiploma" type="file" accept="application/pdf">
        </div>
        <div>
          <label>Autorisation (PDF)</label>
          <input id="adminLicense" type="file" accept="application/pdf">
        </div>
        <div>
          <label>Photo professionnelle</label>
          <input id="adminPhoto" type="file" accept="image/*">
        </div>
        <div>
          <label>Note interne (optionnel)</label>
          <input id="adminDocNote" placeholder="Ex: originaux vus au bureau le 10/02">
        </div>
      </div>

      <div class="modal-actions">
        <button class="saveDocs" id="saveDocsBtn">Enregistrer dossier (upload + Firestore)</button>
        <button class="secondary" id="openAllLinksBtn">Ouvrir tous les liens existants</button>
      </div>

      <div class="section" style="margin-top:10px;color:var(--muted)">
        Les fichiers seront stockÃ©s dans Storage sous : <b>users/{uid}/...</b> (sans toucher tes rules).
      </div>
    </div>
  </div>
</div>

<script type="module">
import { auth, db, storage } from "./firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  collection, getDocs, query, where,
  doc, updateDoc, addDoc, serverTimestamp, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const logoutBtn = document.getElementById("logoutBtn");
const pendingList = document.getElementById("pendingList");
const validatedList = document.getElementById("validatedList");
const rejectedList = document.getElementById("rejectedList");

/* MODAL */
const dossierModal = document.getElementById("dossierModal");
const closeModalBtn = document.getElementById("closeModalBtn");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const saveDocsBtn = document.getElementById("saveDocsBtn");
const openAllLinksBtn = document.getElementById("openAllLinksBtn");

const adminDiploma = document.getElementById("adminDiploma");
const adminLicense = document.getElementById("adminLicense");
const adminPhoto = document.getElementById("adminPhoto");
const adminDocNote = document.getElementById("adminDocNote");

let CURRENT_TARGET_UID = null;

logoutBtn.onclick = async()=>{
  await signOut(auth);
  location.href="/cizahealth/index.html";
};

closeModalBtn.onclick = ()=>{
  dossierModal.classList.remove("open");
  CURRENT_TARGET_UID = null;
  modalBody.innerHTML = "";
  adminDiploma.value = "";
  adminLicense.value = "";
  adminPhoto.value = "";
  adminDocNote.value = "";
};

dossierModal.addEventListener("click",(e)=>{
  if(e.target === dossierModal) closeModalBtn.click();
});

function fmtTS(ts){
  try{
    if(!ts) return "â€”";
    if(typeof ts.toDate === "function") return ts.toDate().toLocaleString();
    if(ts instanceof Date) return ts.toLocaleString();
    return String(ts);
  }catch(_){
    return "â€”";
  }
}

function safe(v){
  return (v===undefined || v===null || v==="") ? "â€”" : v;
}

async function audit(actorId, action, targetId, extra={}){
  await addDoc(collection(db,"auditLogs"),{
    actor: actorId,
    action,
    target: targetId,
    extra,
    at: serverTimestamp()
  });
}

/* ---- ACTIONS BUSINESS (Paiement / Notification / Assign) ---- */
async function sendNotification(actorId, targetUid, title, message){
  // stocke une notif consultable cÃ´tÃ© pro (simple, fiable)
  await addDoc(collection(db, "notifications"),{
    toUid: targetUid,
    title,
    message,
    read: false,
    createdAt: serverTimestamp(),
    createdBy: actorId
  });
  await audit(actorId, "send_notification", targetUid, { title });
}

async function activatePayment(actorId, targetUid){
  // Active le paiement + gÃ©nÃ¨re un slip
  const slipId = "SLIP-" + Date.now();
  await updateDoc(doc(db,"users",targetUid),{
    paymentEnabled: true,
    paymentAgreementSigned: true,
    paymentActivatedAt: serverTimestamp(),
    paymentSlipId: slipId
  });

  await addDoc(collection(db,"paymentSlips"),{
    slipId,
    uid: targetUid,
    method: "Mobile Money (EcoCash / Lumicash / eNoti)",
    status: "active",
    createdAt: serverTimestamp(),
    createdBy: actorId
  });

  await audit(actorId, "activate_payment", targetUid, { slipId });
}

async function assignRequest(actorId, requestId, targetUid){
  // Assignation manuelle dâ€™une requÃªte Ã  un pro (sans casser ton flow)
  // => On met assignedProUid + assignedAt. Ton backend/matching peut lire Ã§a.
  await updateDoc(doc(db,"requests",requestId),{
    assignedProUid: targetUid,
    assignedAt: serverTimestamp(),
    assignedBy: actorId,
    assignMode: "manual_admin"
  });
  await audit(actorId, "assign_request", targetUid, { requestId });
}

/* ---- UPLOAD DOCS (ADMIN) ---- */
async function uploadIfProvided(uid, file, path){
  if(!file) return null;
  const r = ref(storage, path);
  await uploadBytes(r, file);
  return await getDownloadURL(r);
}

saveDocsBtn.onclick = async()=>{
  if(!CURRENT_TARGET_UID) return;

  saveDocsBtn.disabled = true;

  try{
    const targetUid = CURRENT_TARGET_UID;

    const dFile = adminDiploma.files && adminDiploma.files[0] ? adminDiploma.files[0] : null;
    const lFile = adminLicense.files && adminLicense.files[0] ? adminLicense.files[0] : null;
    const pFile = adminPhoto.files && adminPhoto.files[0] ? adminPhoto.files[0] : null;

    const updates = {
      dossierUpdatedAt: serverTimestamp()
    };

    const diplomaUrl = await uploadIfProvided(targetUid, dFile, `users/${targetUid}/diplome.pdf`);
    const licenseUrl = await uploadIfProvided(targetUid, lFile, `users/${targetUid}/autorisation.pdf`);
    const photoUrl = await uploadIfProvided(targetUid, pFile, `users/${targetUid}/photo-pro.jpg`);

    if(diplomaUrl) updates.diplomaPdf = diplomaUrl;
    if(licenseUrl) updates.licensePdf = licenseUrl;
    if(photoUrl) updates.photoUrl = photoUrl;

    if(adminDocNote.value && adminDocNote.value.trim()){
      updates.adminDocNote = adminDocNote.value.trim();
    }

    await updateDoc(doc(db,"users",targetUid), updates);

    await audit(auth.currentUser.uid, "upload_docs_admin", targetUid, {
      diploma: !!diplomaUrl,
      license: !!licenseUrl,
      photo: !!photoUrl
    });

    alert("Dossier mis Ã  jour âœ…");
    location.reload();

  }catch(e){
    console.error(e);
    alert("Erreur upload / dossier");
  }finally{
    saveDocsBtn.disabled = false;
  }
};

openAllLinksBtn.onclick = async()=>{
  if(!CURRENT_TARGET_UID) return;
  const snap = await getDoc(doc(db,"users",CURRENT_TARGET_UID));
  if(!snap.exists()) return;
  const u = snap.data();
  const links = [u.diplomaPdf, u.licensePdf, u.photoUrl].filter(Boolean);
  if(!links.length){
    alert("Aucun lien dossier enregistrÃ©.");
    return;
  }
  links.forEach((l)=>window.open(l,"_blank"));
};

/* AUTH */
onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="/cizahealth/index.html"; return; }

  const adminCheck = await getDocs(
    query(collection(db,"users"),
    where("__name__","==",user.uid),
    where("role","==","admin"))
  );
  if(adminCheck.empty){
    document.body.innerHTML="AccÃ¨s refusÃ©";
    return;
  }

  const snap = await getDocs(
    query(collection(db,"users"),
    where("role","in",["doctor","nurse","aide"]))
  );

  const arr = [];
  snap.forEach((d)=>arr.push({ id:d.id, data:d.data() }));

  // âœ… FIFO: pending triÃ©s par createdAt (le plus ancien d'abord)
  // On garde validated/rejected sans casser, mais on tri pending.
  const pending = arr.filter(x => (x.data.status !== "validated" && x.data.status !== "rejected"));
  const validated = arr.filter(x => x.data.status === "validated");
  const rejected = arr.filter(x => x.data.status === "rejected");

  pending.sort((a,b)=>{
    const ta = a.data.createdAt?.toMillis ? a.data.createdAt.toMillis() : 0;
    const tb = b.data.createdAt?.toMillis ? b.data.createdAt.toMillis() : 0;
    return ta - tb;
  });

  // on peut aussi trier validated (par date validation) si tu veux FIFO sur validÃ©s
  validated.sort((a,b)=>{
    const ta = a.data.validatedAt?.toMillis ? a.data.validatedAt.toMillis() : 0;
    const tb = b.data.validatedAt?.toMillis ? b.data.validatedAt.toMillis() : 0;
    return tb - ta;
  });

  rejected.sort((a,b)=>{
    const ta = a.data.lastStatusChangeAt?.toMillis ? a.data.lastStatusChangeAt.toMillis() : 0;
    const tb = b.data.lastStatusChangeAt?.toMillis ? b.data.lastStatusChangeAt.toMillis() : 0;
    return tb - ta;
  });

  function buildCard(d, u){
    const statusClass =
      u.accountStatus==="suspended" ? "suspended" :
      u.status==="validated" ? "validated" :
      u.status==="rejected" ? "rejected" : "pending";

    const card=document.createElement("div");
    card.className="card";

    // âœ… On ne casse rien : on garde tes sections
    card.innerHTML=`
      <strong>${u.fullName||"â€”"}</strong><br>
      ${u.role} â€¢ ${u.province||""}<br>
      <span class="badge ${statusClass}">
        ${u.accountStatus==="suspended"?"SUSPENDU":(u.status||"EN ATTENTE").toUpperCase()}
      </span>

      <div class="section">
        <strong>FIFO</strong>
        Inscrit le : ${fmtTS(u.createdAt)}
      </div>

      <div class="section">
        <strong>IdentitÃ©</strong>
        Naissance : ${u.birthDate||"â€”"}<br>
        Genre : ${u.gender||"â€”"}<br>
        TÃ©lÃ©phone : <a href="tel:${u.phone}">${u.phone||"â€”"}</a><br>
        Email : ${u.email||"â€”"}
      </div>

      <div class="section">
        <strong>Profession</strong>
        SpÃ©cialitÃ© : ${u.specialty||"â€”"}<br>
        ExpÃ©rience : ${u.experience||"â€”"}
      </div>

      <div class="section">
        <strong>Dossier professionnel</strong>
        ${u.diplomaPdf?`ðŸ“„ <a href="${u.diplomaPdf}" target="_blank">DiplÃ´me</a><br>`:""}
        ${u.licensePdf?`ðŸ“„ <a href="${u.licensePdf}" target="_blank">Autorisation</a><br>`:""}
        ${u.photoUrl?`ðŸ–¼ <a href="${u.photoUrl}" target="_blank">Photo pro</a>`:""}
        ${(!u.diplomaPdf && !u.licensePdf && !u.photoUrl) ? `<span style="color:var(--muted)">Aucun document enregistrÃ©</span>`:""}
      </div>

      <div class="section">
        <strong>Paiement</strong>
        Mobile Money â€” Accord signÃ© : ${u.paymentAgreementSigned?"OUI":"NON"}<br>
        Paiement actif : ${u.paymentEnabled ? "OUI" : "NON"}<br>
        Slip : ${u.paymentSlipId ? u.paymentSlipId : "â€”"}
      </div>

      ${u.proId?`<div class="section"><strong>ProID</strong>${u.proId}</div>`:""}
      ${u.validatedAt?`<div class="section"><strong>ValidÃ© le</strong>${fmtTS(u.validatedAt)}</div>`:""}
      ${u.validationNote?`<div class="section note"><strong>Motif admin</strong>${u.validationNote}</div>`:""}
      ${u.adminDocNote?`<div class="section"><strong>Note dossier</strong>${u.adminDocNote}</div>`:""}
    `;

    const note=document.createElement("textarea");
    note.placeholder="Motif obligatoire (refus / suspension)";

    const actions=document.createElement("div");
    actions.className="actions";

    // âœ… VOIR DOSSIER COMPLET + UPLOAD ADMIN
    const view=document.createElement("button");
    view.className="secondary";
    view.textContent="Voir dossier complet";
    view.onclick=async()=>{
      CURRENT_TARGET_UID = d.id;

      const snap2 = await getDoc(doc(db,"users",d.id));
      if(!snap2.exists()) return;

      const uu = snap2.data();
      modalTitle.textContent = `Dossier â€” ${uu.fullName || "â€”"} (${uu.role || "â€”"})`;

      modalBody.innerHTML = `
        <div class="kv">
          <h4>RÃ©sumÃ©</h4>
          <div class="line"><b>UID</b> : ${d.id}</div>
          <div class="line"><b>ProID</b> : ${safe(uu.proId)}</div>
          <div class="line"><b>Status</b> : ${safe(uu.status)}</div>
          <div class="line"><b>Inscrit le</b> : ${fmtTS(uu.createdAt)}</div>
          <div class="line"><b>Province</b> : ${safe(uu.province)}</div>
        </div>

        <div class="kv">
          <h4>IdentitÃ©</h4>
          <div class="line"><b>Naissance</b> : ${safe(uu.birthDate)}</div>
          <div class="line"><b>Genre</b> : ${safe(uu.gender)}</div>
          <div class="line"><b>TÃ©lÃ©phone</b> : ${safe(uu.phone)}</div>
          <div class="line"><b>Email</b> : ${safe(uu.email)}</div>
        </div>

        <div class="kv">
          <h4>Profession</h4>
          <div class="line"><b>SpÃ©cialitÃ©</b> : ${safe(uu.specialty)}</div>
          <div class="line"><b>ExpÃ©rience</b> : ${safe(uu.experience)}</div>
        </div>

        <div class="kv">
          <h4>Documents (liens actuels)</h4>
          <div class="line">DiplÃ´me : ${uu.diplomaPdf ? `<a href="${uu.diplomaPdf}" target="_blank">Ouvrir</a>` : "â€”"}</div>
          <div class="line">Autorisation : ${uu.licensePdf ? `<a href="${uu.licensePdf}" target="_blank">Ouvrir</a>` : "â€”"}</div>
          <div class="line">Photo : ${uu.photoUrl ? `<a href="${uu.photoUrl}" target="_blank">Ouvrir</a>` : "â€”"}</div>
        </div>

        <div class="kv">
          <h4>Paiement</h4>
          <div class="line"><b>Accord signÃ©</b> : ${uu.paymentAgreementSigned ? "OUI" : "NON"}</div>
          <div class="line"><b>Paiement actif</b> : ${uu.paymentEnabled ? "OUI" : "NON"}</div>
          <div class="line"><b>Slip</b> : ${safe(uu.paymentSlipId)}</div>
        </div>
      `;

      dossierModal.classList.add("open");
    };

    actions.appendChild(view);

    // âœ… VALIDER PRO (inchangÃ©)
    if(u.status!=="validated"){
      const v=document.createElement("button");
      v.className="validate";
      v.textContent="Valider le pro";
      v.onclick=async()=>{
        await updateDoc(doc(db,"users",d.id),{
          status:"validated",
          proId:u.proId || "PRO-"+Date.now(),
          validatedAt:serverTimestamp(),
          validatedBy:auth.currentUser.uid
        });
        await audit(auth.currentUser.uid, "validate_pro", d.id);
        location.reload();
      };
      actions.appendChild(v);
    }

    // âœ… ACTIVER PAIEMENT + SLIP (opÃ©rationnel)
    const payBtn=document.createElement("button");
    payBtn.className="pay";
    payBtn.textContent = u.paymentEnabled ? "Paiement dÃ©jÃ  actif" : "Activer paiement + gÃ©nÃ©rer slip";
    payBtn.disabled = !!u.paymentEnabled;
    payBtn.onclick=async()=>{
      await activatePayment(auth.currentUser.uid, d.id);
      await sendNotification(auth.currentUser.uid, d.id, "Paiement activÃ©", "Votre mode de paiement Mobile Money est activÃ©. Vous serez payÃ© via EcoCash/Lumicash/eNoti dÃ¨s votre prochaine prestation.");
      location.reload();
    };
    actions.appendChild(payBtn);

    // âœ… NOTIFICATION (opÃ©rationnel)
    const n=document.createElement("button");
    n.className="notify";
    n.textContent="Envoyer notification";
    n.onclick=async()=>{
      const msg = prompt("Message Ã  envoyer au professionnel :");
      if(!msg || !msg.trim()) return;
      await sendNotification(auth.currentUser.uid, d.id, "Message administration", msg.trim());
      alert("Notification envoyÃ©e âœ…");
    };
    actions.appendChild(n);

    // âœ… ASSIGN REQUEST (opÃ©rationnel)
    const a=document.createElement("button");
    a.className="assign";
    a.textContent="Assigner une requÃªte Ã  ce pro";
    a.onclick=async()=>{
      const requestId = prompt("RequestID (document id dans collection requests) :");
      if(!requestId || !requestId.trim()) return;
      try{
        await assignRequest(auth.currentUser.uid, requestId.trim(), d.id);
        await sendNotification(auth.currentUser.uid, d.id, "Nouvelle requÃªte assignÃ©e", "Une requÃªte vous a Ã©tÃ© assignÃ©e manuellement par l'administration. Ouvrez votre dashboard pour la traiter.");
        alert("RequÃªte assignÃ©e âœ…");
      }catch(e){
        console.error(e);
        alert("Impossible d'assigner (vÃ©rifie la collection requests / id).");
      }
    };
    actions.appendChild(a);

    // âœ… SUSPENDRE / REACTIVER (inchangÃ© mais note)
    const s=document.createElement("button");
    s.className="suspend";
    s.textContent=u.accountStatus==="suspended"?"RÃ©activer":"Suspendre";
    s.onclick=async()=>{
      const reason = note.value.trim();
      if(!reason) { alert("Motif obligatoire"); return; }
      await updateDoc(doc(db,"users",d.id),{
        accountStatus:u.accountStatus==="suspended"?"active":"suspended",
        validationNote: reason,
        lastStatusChangeAt: serverTimestamp()
      });
      await audit(auth.currentUser.uid, "toggle_suspend", d.id, { reason });
      await sendNotification(auth.currentUser.uid, d.id, "Statut du compte", `Votre compte a Ã©tÃ© ${u.accountStatus==="suspended"?"rÃ©activÃ©":"suspendu"} par l'administration. Motif: ${reason}`);
      location.reload();
    };

    // âœ… REFUSER (inchangÃ© mais note + notif)
    const r=document.createElement("button");
    r.className="reject";
    r.textContent="Refuser";
    r.onclick=async()=>{
      const reason = note.value.trim();
      if(!reason) { alert("Motif obligatoire"); return; }
      await updateDoc(doc(db,"users",d.id),{
        status:"rejected",
        validationNote: reason,
        lastStatusChangeAt: serverTimestamp()
      });
      await audit(auth.currentUser.uid, "reject_pro", d.id, { reason });
      await sendNotification(auth.currentUser.uid, d.id, "Demande refusÃ©e", `Votre demande a Ã©tÃ© refusÃ©e. Motif: ${reason}`);
      location.reload();
    };

    actions.append(s,r,note);
    card.appendChild(actions);

    return card;
  }

  // Render
  pending.forEach(({id,data})=>{
    const card = buildCard({id}, data);
    pendingList.appendChild(card);
  });

  validated.forEach(({id,data})=>{
    const card = buildCard({id}, data);
    validatedList.appendChild(card);
  });

  rejected.forEach(({id,data})=>{
    const card = buildCard({id}, data);
    rejectedList.appendChild(card);
  });

});
</script>

</body>
</html>
