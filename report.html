<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CizaHealth+ | Rapport m√©dical</title>

<style>
:root{
  --primary:#123C8A;
  --bg:#F4F7FB;
  --card:#FFFFFF;
  --text:#0A1A2F;
  --muted:#6B7A90;
  --success:#1B6B3A;
  --danger:#C0392B;
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:900px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  background:linear-gradient(90deg,var(--primary),#0B2C66);
  padding:18px 22px;
  color:#fff;
}
header strong{font-size:18px}
header span{font-size:13px;opacity:.9}

main{
  padding:26px;
  flex:1;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:26px;
  box-shadow:0 12px 32px rgba(10,42,94,.08);
}
.field{
  margin-bottom:22px;
}
.field label{
  display:block;
  font-weight:800;
  margin-bottom:8px;
}
.field textarea{
  width:100%;
  min-height:90px;
  padding:14px;
  border-radius:14px;
  border:1px solid #dde3ef;
  font-family:inherit;
  font-size:14px;
  resize:vertical;
}
.actions{
  margin-top:28px;
  display:flex;
  gap:14px;
}
button{
  border:none;
  border-radius:999px;
  padding:14px 26px;
  font-weight:900;
  cursor:pointer;
}
.submit{
  background:var(--success);
  color:#fff;
}
.submit:disabled{
  background:#b7c9bf;
  cursor:not-allowed;
}
.cancel{
  background:#eaeef5;
  color:var(--primary);
}
.footer-note{
  margin-top:18px;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="app">

<header>
  <strong>Rapport m√©dical</strong><br>
  <span id="headerMeta">Chargement‚Ä¶</span>
</header>

<main>
  <div class="card">

    <div class="field">
      <label>üßæ Motif de consultation</label>
      <textarea id="motif"></textarea>
    </div>

    <div class="field">
      <label>ü©∫ Diagnostic</label>
      <textarea id="diagnostic"></textarea>
    </div>

    <div class="field">
      <label>üëÅÔ∏è Observations cliniques</label>
      <textarea id="observations"></textarea>
    </div>

    <div class="field">
      <label>üíä Traitement / Prescription</label>
      <textarea id="traitement"></textarea>
    </div>

    <div class="field">
      <label>üìå Recommandations</label>
      <textarea id="recommandations"></textarea>
    </div>

    <div class="actions">
      <button class="submit" id="submitBtn" disabled>
        ‚úÖ Soumettre le rapport
      </button>
      <button class="cancel" id="cancelBtn">
        Retour
      </button>
    </div>

    <div class="footer-note">
      ‚ö†Ô∏è Une fois soumis, le rapport ne pourra plus √™tre modifi√©.
    </div>

  </div>
</main>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc, getDoc, setDoc, serverTimestamp
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const requestId = params.get("requestId");

const headerMeta = document.getElementById("headerMeta");
const submitBtn = document.getElementById("submitBtn");
const cancelBtn = document.getElementById("cancelBtn");

const fields = {
  motif: document.getElementById("motif"),
  diagnostic: document.getElementById("diagnostic"),
  observations: document.getElementById("observations"),
  traitement: document.getElementById("traitement"),
  recommandations: document.getElementById("recommandations")
};

function checkValidity(){
  const ok = Object.values(fields).every(f => f.value.trim().length > 3);
  submitBtn.disabled = !ok;
}

Object.values(fields).forEach(f => f.addEventListener("input", checkValidity));

onAuthStateChanged(auth, async(user)=>{
  if(!user || !requestId) return location.href="index.html";

  const reqRef = doc(db,"requests",requestId);
  const reqSnap = await getDoc(reqRef);
  if(!reqSnap.exists()) return alert("Consultation introuvable");

  const r = reqSnap.data();
  if(user.uid !== r.assignedProUid){
    alert("Acc√®s refus√©");
    return;
  }

  headerMeta.textContent =
    `Patient : ${r.patientName || "‚Äî"} ‚Ä¢ ${r.province || ""}`;
});

submitBtn.onclick = async()=>{
  submitBtn.disabled = true;

  await setDoc(doc(db,"reports",requestId),{
    requestId,
    content:{
      motif: fields.motif.value.trim(),
      diagnostic: fields.diagnostic.value.trim(),
      observations: fields.observations.value.trim(),
      traitement: fields.traitement.value.trim(),
      recommandations: fields.recommandations.value.trim()
    },
    submittedAt: serverTimestamp(),
    status:"submitted"
  });

  location.href = `rapport-confirmation.html?requestId=${requestId}`;
};

cancelBtn.onclick = ()=> history.back();
</script>

</body>
</html>
