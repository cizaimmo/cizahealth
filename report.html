<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CizaHealth+ | Rapport m√©dical</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter;
  background:#f4f7fb;
  color:#0a1a2f;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
h1{font-size:20px;margin-bottom:20px}
.card{
  background:#fff;
  padding:18px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
  margin-bottom:18px;
}
input, textarea, select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-top:6px;
  margin-bottom:14px;
}
button{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  background:#123c8a;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.med-block{
  border:1px solid #eee;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
}
</style>
</head>
<body>

<div class="container">
<h1>Rapport m√©dical</h1>

<div class="card">
<label>Motif</label>
<textarea id="motif"></textarea>

<label>Diagnostic</label>
<textarea id="diagnostic"></textarea>

<label>Traitement global</label>
<textarea id="traitement"></textarea>

<label>Pays</label>
<select id="country">
<option value="BI">Burundi</option>
<option value="RW">Rwanda</option>
<option value="CD">RD Congo</option>
<option value="KE">Kenya</option>
<option value="UG">Uganda</option>
<option value="TZ">Tanzania</option>
<option value="ET">Ethiopia</option>
<option value="SS">South Sudan</option>
</select>

<label>
<input type="checkbox" id="needRx">
 Ordonnance n√©cessaire
</label>

<div id="medicationsContainer"></div>

<button type="button" onclick="addMedication()">+ Ajouter m√©dicament</button>

<br><br>
<button id="submitBtn" onclick="submitReport()">Envoyer rapport</button>
</div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  doc, getDoc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const urlParams = new URLSearchParams(window.location.search);
const requestId = urlParams.get("requestId");

let medications = [];

window.addMedication = function(){
  const container = document.getElementById("medicationsContainer");
  const index = medications.length;

  medications.push({});

  const div = document.createElement("div");
  div.className="med-block";
  div.innerHTML = `
    <label>Nom m√©dicament</label>
    <input onchange="medications[${index}].name=this.value">

    <label>DCI</label>
    <input onchange="medications[${index}].dci=this.value">

    <label>Dosage</label>
    <input onchange="medications[${index}].dosage=this.value">

    <label>Forme</label>
    <input onchange="medications[${index}].form=this.value">

    <label>Posologie</label>
    <input onchange="medications[${index}].posology=this.value">

    <label>Dur√©e</label>
    <input onchange="medications[${index}].duration=this.value">

    <label>Instructions</label>
    <input onchange="medications[${index}].instructions=this.value">
  `;
  container.appendChild(div);
};

window.submitReport = async function(){
  const user = auth.currentUser;
  if(!user) return alert("Non connect√©");
  if(!requestId) return alert("Consultation introuvable");

  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.textContent = "Envoi...";

  try{

    // üîπ IMPORTANT : r√©cup√©rer la demande pour obtenir patientUid
    const reqSnap = await getDoc(doc(db,"requests",requestId));
    if(!reqSnap.exists()){
      alert("Demande introuvable");
      submitBtn.disabled = false;
      submitBtn.textContent = "Envoyer rapport";
      return;
    }

    const requestData = reqSnap.data();

    const data = {
      requestId,
      patientUid: requestData.patientUid,   // ‚úÖ AJOUT CRUCIAL
      proUid: user.uid,
      motif: document.getElementById("motif").value,
      diagnostic: document.getElementById("diagnostic").value,
      traitement: document.getElementById("traitement").value,
      ordonnance: document.getElementById("needRx").checked,
      medications,
      country: document.getElementById("country").value,
      region: "East Africa",
      status: "submitted",
      submittedAt: serverTimestamp()
    };

    // üîπ REPORT
    await setDoc(doc(db,"reports",requestId),data);

    // üîπ PRESCRIPTION
    if(data.ordonnance){
      const code = "RX-" + Math.random().toString(36).substring(2,8).toUpperCase();

      await setDoc(doc(db,"prescriptions",requestId),{
        ...data,
        code,
        used:false,
        createdAt:serverTimestamp(),
        expiresAt:new Date(Date.now() + 14*24*60*60*1000)
      });
    }

    alert("Rapport envoy√©");
    location.href="dashboard-pro.html";

  }catch(e){
    console.error(e);
    alert("Erreur lors de l‚Äôenvoi");
    submitBtn.disabled = false;
    submitBtn.textContent = "Envoyer rapport";
  }
};
</script>

</body>
</html>
